# 0. å‰è¨€

## I. éœ€æ±‚

ç”±äºæˆ‘å¸Œæœ›èƒ½å¤Ÿæœ‰ä¸€æ¬¾**å¯ç§äººéƒ¨ç½²**ã€**å¤šäººå®æ—¶ååŒ**ã€**ç”¨æˆ·æƒé™ç®¡ç†**ã€**è‡ªç”±åˆ†äº«åˆ°äº’è”ç½‘**çš„**Markdown**çŸ¥è¯†åº“ç®¡ç†å¹³å°ï¼Œä½†ä¾æ¬¡å°è¯•äº†ç°æœ‰çš„è…¾è®¯æ–‡æ¡£æ™ºèƒ½æ–‡æ¡£ã€è¯­é›€ã€Docsifyã€Obsidianã€HackMDã€CodiMDã€Typoraã€æ€æºç­‰ç­‰ç­‰ç­‰ï¼Œéƒ½ä¸èƒ½å¾ˆå®Œç¾åœ°æ»¡è¶³æˆ‘çš„éœ€æ±‚ï¼ˆè¿™å¹¶éè¸©ä¸€æ§ä¸€ï¼Œæˆ‘ç°åœ¨å°±æ˜¯åœ¨ç”¨ Typora æœ¬åœ°å®Œæˆè¿™ç¯‡æ–‡ç« ï¼Œå†ç”¨ Docsify éƒ¨ç½²åˆ°äº‘ç«¯ï¼Œçœ‹éœ€æ±‚é€‰æ‹©è½¯ä»¶ï¼‰

å…¶ä¸­ HackMD å·²ç»å¾ˆæ¥è¿‘ï¼Œå”¯ä¸€ç¾ä¸­ä¸è¶³çš„æ˜¯ä¸èƒ½æƒé™ç®¡ç†ï¼Œè¦ä¹ˆéƒ½ä¸èƒ½ååŒï¼Œè¦ä¹ˆå…¨ä¸–ç•Œäººéƒ½å¯ä»¥ååŒï¼ˆç­‰åŒäºæ‹¥æœ‰åˆ é™¤æƒé™ï¼‰ï¼Œæ‰€ä»¥ç”¨èµ·æ¥è¿˜æ˜¯ä¸å¤ªæ”¾å¿ƒã€‚

æˆ‘ä¹Ÿä¸è®°å¾—åœ¨å“ªçœ‹åˆ°çš„ä»‹ç»ï¼Œæ€»ä¹‹åœ¨æˆ‘å¿«è¦æ”¾å¼ƒå¯»æ‰¾çš„æ—¶å€™å‘ç°äº†è¶…çº§å‰å®³çš„ Github 20+Kâ­ çš„ **Outline**: [https://github.com/outline/outline](https://github.com/outline/outline)ï¼Œè¯´å®è¯æˆ‘åœ¨ä¸­æ–‡äº’è”ç½‘ä¸Šå‡ ä¹çœ‹ä¸åˆ°å®ƒçš„èº«å½±å’Œå®£ä¼ è§†é¢‘ï¼Œå³ä½¿æ˜¯ç‰¹æ„å»æœï¼Œä¹Ÿå¯¥å¯¥æ— å‡ ï¼Œè¿™ä¸æ˜¯å› ä¸ºå®ƒä¸ä¼˜ç§€ï¼Œæˆ‘æ€»ç»“åŸå› æœ‰ä»¥ä¸‹å‡ ç‚¹: 

- **åç§°å¤§ä¼—åŒ–**: Outline å¯ä»¥æ˜¯ CSSã€VPNã€æ ‡é¢˜ä¸­ä¸€ä¸ªæ™®æ™®é€šé€šçš„åŠ¨è¯å’Œåè¯ï¼Œç”šè‡³æˆ‘æœ Outline å‡ºæ¥çš„æ˜¯ Obsidian çš„æ’ä»¶â€¦â€¦

- **éƒ¨ç½²å›°éš¾**: éƒ¨ç½²èµ·æ¥çš„éš¾åº¦å·¨å¤§ï¼Œä¾èµ–æœåŠ¡ç‰¹åˆ«å¤š
- **ç¬¬ä¸‰æ–¹ OIDC æœåŠ¡é—¨æ§›é«˜**: ç¬¬ä¸€é“é—¨æ§›æ˜¯è´¹ç”¨ï¼Œç¬¬äºŒé“é—¨æ§›æ˜¯ä¼ä¸šé‚®ç®±ã€‚**æ‰€ä»¥æˆ‘ä»¬é€‰æ‹©æœ¬åœ°éƒ¨ç½²çš„ OIDC æœåŠ¡ï¼Œè€Œè¦å®ç°ç§äººéƒ¨ç½²çš„å•ç‚¹ç™»å½•ç³»ç»Ÿçš„è¯æ˜¯ç›¸å½“å¤æ‚çš„ï¼**

ç”±äºè¯¥é¡¹ç›®éœ€è¦å•ç‚¹ç™»å½•æœåŠ¡ã€å¯¹è±¡å­˜å‚¨æœåŠ¡å’Œå„ç§å¤æ‚çš„é…ç½®ï¼Œå³ä½¿æœ‰å®˜æ–¹æ–‡æ¡£å¸®å¿™ï¼Œä¹Ÿè¿˜æ˜¯å›°éš¾é‡é‡ã€‚è€Œå…¶ä»–äººåˆ†äº«çš„éƒ¨ç½²æ–¹æ³•æœ‰äº›åœ°æ–¹æ²¡æœ‰è®²æ¸…æ¥šï¼Œæœ‰äº›åœ°æ–¹ä¹Ÿä¸èƒ½å¾ˆå¥½åœ°é€‚åº”æ‰€æœ‰äººçš„æœåŠ¡å™¨ï¼ˆå› ä¸ºæ¯•ç«ŸæœåŠ¡å™¨å¯èƒ½è¿˜éœ€è¦è·‘å…¶ä»–è½¯ä»¶ï¼Œ80ç«¯å£æ—©å°±è¢«å ç”¨äº†ï¼‰

ç»è¿‡è¿™å‡ å¤©çš„éƒ¨ç½²å®æˆ˜ï¼Œæ‘¸ç´¢å‡ºäº†ä¸€å¥—åŸºäº Nginx All In One çš„ Docker ç½‘ç»œæ¶æ„éƒ¨ç½²æ¨¡å¼ï¼Œåªè¦ä½ çš„æœåŠ¡å™¨æ˜¯ç”¨ Nginx ä»£ç†ï¼Œé‚£ä¹ˆè¿™å¥—æ–¹æ³•å¾ˆé€‚åˆä½ ã€‚

æˆ‘ç›¸ä¿¡ä½ ä¸€å®šèƒ½åœ¨ 30 åˆ†é’Ÿå†…å®Œæˆè¿™ä¸€åˆ‡çš„ã€‚


## II. Outline ç®€ä»‹

å®˜ç½‘: https://www.getoutline.com/

ç›¸å…³ä»‹ç»è§†é¢‘: 

- Bilibili: https://www.bilibili.com/video/BV1zs4y1f7J3
- Youtube: https://www.youtube.com/watch?v=UjG4lB2u-r4&t=343s



Outline æ˜¯ä¸€ä¸ªå¼€æºçš„çŸ¥è¯†åº“å’Œå›¢é˜Ÿåä½œå·¥å…·ğŸ§ ï¼Œæ—¨åœ¨å¸®åŠ©å›¢é˜Ÿå…±äº«ã€ç»„ç»‡å’Œåä½œæ–‡æ¡£ğŸ“ã€‚å®ƒæä¾›äº†ä¸€ä¸ªç®€æ´çš„ç•Œé¢ï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿè½»æ¾åˆ›å»ºã€ç¼–è¾‘å’ŒæŸ¥çœ‹æ–‡æ¡£ã€‚

ä»¥ä¸‹æ˜¯ Outline çš„ä¸€äº›ä¸»è¦ç‰¹ç‚¹: 

1. **å®æ—¶åä½œ**ğŸ‘¥: å›¢é˜Ÿæˆå‘˜å¯ä»¥å®æ—¶ç¼–è¾‘å’Œè¯„è®ºæ–‡æ¡£ï¼Œæé«˜åä½œæ•ˆç‡ã€‚
2. **å¯Œæ–‡æœ¬ç¼–è¾‘å™¨**ğŸ“„: æ”¯æŒ Markdown è¯­æ³•ï¼Œå…è®¸ç”¨æˆ·è½»æ¾æ ¼å¼åŒ–æ–‡æœ¬ã€æ’å…¥å›¾ç‰‡ã€é“¾æ¥ç­‰ã€‚
3. **æ–‡æ¡£ç»„ç»‡**ğŸ“‚: ç”¨æˆ·å¯ä»¥é€šè¿‡æ–‡ä»¶å¤¹å’Œé›†åˆæ¥ç»„ç»‡æ–‡æ¡£ï¼Œä½¿å†…å®¹æ˜“äºæŸ¥æ‰¾å’Œç®¡ç†ã€‚
4. **æƒé™ç®¡ç†**ğŸ”’: å¯ä»¥è®¾ç½®ä¸åŒçº§åˆ«çš„è®¿é—®æƒé™ï¼Œç¡®ä¿æ•æ„Ÿä¿¡æ¯çš„å®‰å…¨ã€‚
5. **é›†æˆç¬¬ä¸‰æ–¹æœåŠ¡**ğŸ”—: Outline å¯ä»¥ä¸ Slackã€GitHub ç­‰ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆï¼Œæ–¹ä¾¿å›¢é˜Ÿåä½œã€‚
6. **è‡ªæ‰˜ç®¡æˆ–äº‘æœåŠ¡**â˜ï¸: Outline å¯ä»¥åœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Šæ‰˜ç®¡ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å®˜æ–¹æä¾›çš„äº‘æœåŠ¡ã€‚
7. **å¼€æº**ğŸ’»: Outline æ˜¯å¼€æºè½¯ä»¶ï¼Œå…è®¸å¼€å‘äººå‘˜æ ¹æ®è‡ªå·±çš„éœ€æ±‚è¿›è¡Œå®šåˆ¶å’Œæ‰©å±•ã€‚

æ€»çš„æ¥è¯´ï¼ŒOutline æ˜¯ä¸€ä¸ªåŠŸèƒ½ä¸°å¯Œçš„æ–‡æ¡£ç®¡ç†å’Œå›¢é˜Ÿåä½œå¹³å°ğŸš€ï¼Œé€‚ç”¨äºå„ç§è§„æ¨¡çš„å›¢é˜Ÿå’Œé¡¹ç›®ã€‚

ã€GPT By ChatGPT4.0ã€‘

![0-outline-updated](./assets/0-outline-updated.png)



## III. ç¯å¢ƒè¯´æ˜

ä¸‹é¢æ˜¯æˆ‘æœåŠ¡å™¨ç”Ÿäº§ç¯å¢ƒçš„è¯¦ç»†è¯´æ˜ï¼Œå¦‚æœ‰ä¸åŒä¸ä»£è¡¨ä¸èƒ½è¿è¡Œï¼Œå¯èƒ½å­˜åœ¨ç»†å¾®å·®åˆ«ï¼Œæ¯”å¦‚ CentOS å’Œ Ubuntu

- æœåŠ¡å™¨: è…¾è®¯äº‘-è½»é‡åº”ç”¨æœåŠ¡å™¨
- ç³»ç»Ÿæ¶æ„: AMD x86_64
- ç³»ç»Ÿç‰ˆæœ¬: CentOS Linux release 7.6.1810 (Core)
- å®ä¾‹è§„æ ¼: 
  - CPU: 2 æ ¸
  - å†…å­˜: 4 GB
  - ç³»ç»Ÿç›˜: SSD äº‘ç¡¬ç›˜ 50 GB
  - æµé‡åŒ…: 800 GB/æœˆï¼ˆå¸¦å®½: 6 Mbpsï¼‰



## IV. Contact

æœ¬æ–‡äº2023å¹´08æœˆ13æ—¥å®Œæˆï¼Œå¦‚æœ‰é—®é¢˜æ¬¢è¿è”ç³»æˆ‘ğŸ˜Š: 

- emailtojiang@gmail.com
- emailtojiang@163.com



# 1. æ¶æ„å›¾

ä¸‹å›¾ä¸ºæ•´ä¸ªé¡¹ç›®çš„ç³»ç»Ÿæ¶æ„: 

![1-architecture-diagram](./assets/1-architecture-diagram-v4.png)

æ¶‰åŠåˆ°çš„ Outline æœåŠ¡ä»¥åŠå®ƒçš„ä¾èµ–æœåŠ¡: 

- **Outline**: è¶…çº§æ£’çš„å›¢é˜Ÿå¤šäººååŒæ–‡æ¡£ç®¡ç†å¼€æºé¡¹ç›®ï¼3000 ç«¯å£ä¸ºè®¿é—® Outline çš„ç«¯å£ï¼Œä½†è¯¥ç«¯å£å¹¶ä¸æš´éœ²ï¼Œç”± Nginx é€šè¿‡ Docker Network æ–¹å¼è®¿é—®
- **Keycloak**: ä¸€ä¸ªæ”¯æŒ OpenID Connectï¼ˆä¸‹æ–‡ç®€ç§° **OIDC**ï¼‰çš„å¼€æºé¡¹ç›®ã€‚ç”¨äº Outline çš„å•ç‚¹ç™»å½•æœåŠ¡ã€‚
- **Redis**: éå…³ç³»å‹æ•°æ®åº“ï¼ŒOutline ä½¿ç”¨ Redis å®ç°ç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—ã€ä¼šè¯å­˜å‚¨ã€å®æ—¶åä½œç­‰åŠŸèƒ½
- **PostgreSQL**: å…³ç³»å‹æ•°æ®åº“ï¼ŒOutline ä½¿ç”¨ PostgreSQL å®ç°æ•°æ®çš„æŒä¹…åŒ–
- **Minio**: ä¸€æ¬¾æœ¬åœ°**å¯¹è±¡å­˜å‚¨ç³»ç»Ÿ**çš„å¼€æºé¡¹ç›®ã€‚ç”¨äºå­˜å‚¨ Outline çš„å›¾ç‰‡ç­‰èµ„æº

ç½‘ç»œæ¶æ„ä¸»å¹²:

- **nginx_all_in_one**: Docker Networkï¼Œä½¿ç”¨è™šæ‹Ÿç½‘å¡å®ç°å¤šä¸ªå®¹å™¨ä¹‹é—´çš„ç½‘ç»œäº’é€š
- **Nginx**: å ç”¨ä¸»æœºçš„ 80, 443 ç«¯å£å¹¶åä»£äº†å››ä¸ªåŸŸåï¼Œè€Œåä»£çš„ç«¯å£ç¡®å®æ¥è‡ªè™šæ‹Ÿå±€åŸŸç½‘ä¸­çš„ç«¯å£ï¼Œç”±å›¾ä¸­å¯çŸ¥æ•´ä¸ªç½‘ç»œåªæœ‰ 80 å’Œ 443 ç«¯å£æš´éœ²åœ¨å¤–ã€‚

å››ä¸ªåŸŸåçš„ä½œç”¨: 

- `outline.example.com`: ç”¨äºè®¿é—® Outline çš„ä¸»åŸŸå
- `sso.example.com`: æä¾›èº«ä»½æƒé™éªŒè¯æœåŠ¡ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ç®¡ç†å‘˜å…¥å£
- `minio.example.com`: MinIO API ä¸º Outline æä¾›å¯¹è±¡å­˜å‚¨æœåŠ¡ OSS
- `minio.example.com`: MinIO Admin ç•Œé¢

è¿™ç§éƒ¨ç½²æ–¹å¼çš„ä¼˜ç‚¹å¦‚ä¸‹: 

- **å®‰å…¨æ€§æ›´é«˜**ğŸ”’: æ‰€æœ‰æœåŠ¡å‡éšè—ä¸è™šæ‹Ÿå±€åŸŸç½‘ä¸­ï¼Œå¹¶åœ¨è™šæ‹Ÿå±€åŸŸç½‘ä¸­é€šä¿¡ï¼Œä¸ä¼šæš´éœ²åœ¨äº’è”ç½‘ä¸Š
- **é—¨æ§›ä½**ğŸ: å…¨æ–‡æ‰€æœ‰æœåŠ¡é¡¹å‡ä½¿ç”¨ Docker éƒ¨ç½²ï¼Œå¹¶ä½¿ç”¨ Compose æ’ä»¶ï¼Œä¿—ç§°å¼€ç®±å³ç”¨ï¼Œéƒ¨ç½²éš¾åº¦å¤§å¤§é™ä½ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œä½ åªéœ€è¦æ–°å»ºä¸€ä¸ª `yaml` é…ç½®æ–‡ä»¶å’Œæ‰§è¡Œä¸€æ¡å‘½ä»¤ `docker-compose up -d` å³å¯ã€‚
- **éä¾µå…¥å¼çš„ç«¯å£å‹å¥½å‹**ğŸšª: æ‰€æœ‰æœåŠ¡éƒ½ä¸ä¼šå ç”¨æœåŠ¡å™¨çš„ä»»ä½•ä¸€ä¸ªç«¯å£ã€‚ç”±å ç”¨ 80 ç«¯å£çš„ Nginx è´Ÿè´£åå‘ä»£ç†è½¬å‘åˆ° è™šæ‹Ÿå±€åŸŸç½‘ ä¸­çš„æœåŠ¡è®¿é—®ç‚¹ SAP
- **éä¾µå…¥å¼çš„ç¯å¢ƒå‹å¥½å‹**ğŸ³: æ‰€æœ‰æœåŠ¡å‡ä½¿ç”¨ Docker å®¹å™¨åŒ–éƒ¨ç½²ï¼Œä¸ä¼šåœ¨æœåŠ¡å™¨ä¸­åˆ›å»ºä¸€å¤§å †çš„ç¯å¢ƒå˜é‡
- **åæœŸè°ƒè¯•å‹å¥½å‹**ğŸ”§: æ‰€æœ‰æœåŠ¡å‡ä½¿ç”¨ Docker Compose æ’ä»¶éƒ¨ç½²ï¼Œæ‰€æœ‰é…ç½®é¡¹ã€å¯†ç ç­‰éƒ½ä¿å­˜åœ¨äº†æœåŠ¡å™¨ä¸­ï¼Œè¾ƒåŸå…ˆçš„çº¯ Docker éƒ¨ç½²è€Œè¨€ï¼Œå¯¹äºåæœŸè°ƒè¯•æ— éœ€ç¿»æ‰¾å½“æ—¶è®¾ç½®çš„æ‰€æœ‰é…ç½®é¡¹ã€‚

---

ä¸‹é¢å°†æ­£å¼å¼€å§‹å®Œæ•´çš„éƒ¨ç½²æµç¨‹ ğŸš€ğŸ› ï¸



# 2. Nginx éƒ¨ç½²

## 2.1 æ¦‚è¿°

Nginx æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ HTTP å’Œåå‘ä»£ç† WEB æœåŠ¡å™¨ã€‚

æˆ‘ä»¬ä½¿ç”¨ä»–å¯ä»¥è®©æˆ‘ä»¬ç”¨å¤šä¸ªåŸŸåè®¿é—®åŒä¸€ä¸ª IP çš„åŒä¸€ä¸ªç«¯å£ï¼ŒåŒæ—¶è¿˜å¯ä»¥è®©æˆ‘ä»¬çš„åº”ç”¨æ”¯æŒ HTTPS æœåŠ¡ã€‚

åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Nginx åä»£äº† Outlineã€Keycloakã€MinIO



## 2.2 é…ç½®åŸŸå

### 2.2.1 éœ€è¦äº†è§£çš„

**æ³¨æ„â€¼: å…¨æ–‡ä¸­å‡ºç°çš„ä»»ä½• `*.example.com` ä¸€å¾‹åˆ‡æ¢æˆè‡ªå·±çš„åŸŸå**

**å‡å¦‚æˆ‘çš„åŸŸåæ˜¯ `mydomain.xyz`ï¼Œé‚£ä¹ˆ `outline.example.com` åº”è¯¥å¯¹åº”ç€æˆ‘çš„ `outline.mydomain.xyz`**

ç”±æ¶æ„å›¾å¯çŸ¥ï¼Œæˆ‘ä»¬å…±éœ€é…ç½®å››ä¸ªåŸŸå: 

- **outline.example.com**: è®¿é—®ç¬”è®°çš„ä¸»å…¥å£
- **sso.example.com**: OIDC å•ç‚¹ç™»å½•é¡µé¢ï¼Œç‚¹å‡» outline é¦–é¡µçš„ç™»é™†è‡ªåŠ¨è·³è½¬
- **minio.example.com**: å¯¹è±¡å­˜å‚¨æœåŠ¡çš„ API è®¿é—®ç‚¹
- **minio-admin.example.com**: å¯¹è±¡å­˜å‚¨æœåŠ¡çš„åå°ç®¡ç†è®¿é—®ç‚¹

**ä»¥ä¸‹å‡ä»¥è…¾è®¯äº‘æœåŠ¡å™¨ä¸ºä¾‹ï¼Œå…¶ä»–æœåŠ¡å™¨å¤§è‡´è¿‡ç¨‹ç±»ä¼¼ï¼Œä¸¾ä¸€åä¸‰å³å¯**



### 2.2.2 æœåŠ¡å™¨åŸŸåé…ç½®

ç™»é™† [DNS è§£æ DNSPod](https://console.cloud.tencent.com/cns) æ‰“å¼€ä½ çš„åŸŸåï¼Œç‚¹å‡»æ·»åŠ è®°å½•

![2-click-to-add](./assets/2-click-to-add.png)

æ·»åŠ å¦‚ä¸‹å››ä¸ªå­åŸŸåï¼Œè®°å½•å€¼å³æœåŠ¡å™¨IPä¸ºä½ è‡ªå·±æœåŠ¡å™¨çš„IP

![2-subdomain-configuration](./assets/2-subdomain-configuration.png)



## 2.3 è·å– SSL è¯ä¹¦

è…¾è®¯äº‘æœåŠ¡å™¨ä¸ºæ¯åç”¨æˆ·æä¾›äº† 50 å¼ å…è´¹è¯ä¹¦çš„ç”³è¯·èµ„æ ¼ï¼ˆè¿‡æœŸæˆ–è‡ªè¡Œåˆ é™¤èµ„æ ¼æ•°æ¢å¤ï¼‰

ç™»é™† [SSL è¯ä¹¦](https://console.cloud.tencent.com/ssl)ï¼Œä¾æ¬¡æ‰“å¼€ æˆ‘çš„è¯ä¹¦-å…è´¹è¯ä¹¦-ç”³è¯·å…è´¹è¯ä¹¦

![2-apply-free-ssl](./assets/2-apply-free-ssl.png)

æ³¨æ„ä¸‹é¢åŸŸåæ˜¯è‡ªå·±çš„ï¼Œä¾æ¬¡ç»‘å®š`outline.example.com`ã€`sso.example.com`ã€`minio.example.com`ã€`minio-admin.example.com`

é€‰æ‹©**è‡ªåŠ¨DNSéªŒè¯**: ä¼šè‡ªåŠ¨å¸®ä½ æ·»åŠ åŸŸåéªŒè¯è®°å½•ï¼Œä¸ç”¨æ‰‹åŠ¨æ·»åŠ ï¼ˆå¦‚æœå…¶ä»–æœåŠ¡å™¨åªæœ‰æ‰‹åŠ¨ï¼Œåˆ™æ ¹æ®ç›¸å¯¹åº”æç¤ºè‡ªè¡Œæ·»åŠ åŸŸåéªŒè¯è®°å½•ï¼‰

å‹¾é€‰**è‡ªåŠ¨åˆ é™¤éªŒè¯**: éªŒè¯å®Œå¯è‡ªç”±åˆ é™¤DNSåŸŸåéªŒè¯è®°å½•ï¼ˆå¦‚æœå…¶ä»–æœåŠ¡å™¨æ²¡æœ‰ä¹Ÿä¸è¦ç´§ï¼‰

![2-apply-free-ssl-2](./assets/2-apply-free-ssl-2.png)

SSL è¯ä¹¦å°†äº¤ç”±åå°å®¡æ ¸ï¼Œåœ¨æ­¤æœŸé—´å…ˆå®ŒæˆNginxçš„éƒ¨ç½²ã€‚



## 2.4 ä½¿ç”¨ Docker&Compose éƒ¨ç½² Nginx ä¸ç½‘ç»œ

TIPğŸ’¡: SSL ç”³è¯·é¡µé¢å…ˆåˆ«å…³ï¼Œä¹‹åè¿˜éœ€è¦ä¸‹è½½ SSL è¯ä¹¦ã€‚

å¦‚æœä½ è¿˜æ²¡æœ‰å®‰è£… Docker å’Œ Docker-Composeï¼Œå¯ä»¥å…ˆå‚è€ƒ [å®˜æ–¹æ–‡æ¡£](https://docs.docker.com/compose/) æˆ– å…¶ä»–åšå®¢ã€‚è¿™é‡Œæé†’ä¸€å¥å¦‚æœä½ å·²ç»è£…å¥½äº†çš„ Docker ç‰ˆæœ¬è¿‡ä½çš„è¯ï¼Œæ˜¯éœ€è¦è€ƒè™‘ç‰ˆæœ¬å¯¹åº”å…³ç³»çš„: [ç‰ˆæœ¬å¯¹åº”å…³ç³»](https://docs.docker.com/compose/compose-file/compose-versioning/)



### 2.4.1 åˆ›å»º Docker Network

æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºåä¸º `nginx_all_in_one` çš„ Docker Networkï¼Œå½“ç„¶è¿™ä¸ªåå­—æ˜¯è‡ªå®šä¹‰çš„

```bash
# åˆ›å»ºåä¸º "nginx_all_in_one" çš„ Docker Network
docker network create -d bridge nginx_all_in_one
# ä¹Ÿå¯ä»¥ç›´æ¥åˆ›å»ºï¼Œå› ä¸ºé»˜è®¤ç½‘ç»œç±»å‹å°±æ˜¯ bridge
docker network create nginx_all_in_one
```



### 2.4.2 åˆ›å»º Nginx

åœ¨è¿™é‡Œçº¦å®šæœ¬æ–‡ä¸­æ‰€æœ‰å†…å®¹å‡æ”¾ç½®åœ¨ `/home/docker-compose/` ç›®å½•ä¸‹

é¦–å…ˆåˆ›å»ºæ–‡ä»¶å¤¹å’Œ `docker-compose.yaml`ï¼ˆ`docker-compose` é»˜è®¤ä»¥å½“å‰ç›®å½•ä¸‹çš„ `docker-compose.yaml` å¯åŠ¨ï¼Œä¸ºäº†ä¸åæ–‡ä¸­çš„ `yaml` ç›¸åŒºåˆ«ï¼Œå‡ä½¿ç”¨ç›¸å¯¹æ¸…æ™°çš„åç§°ä»¥è¡¨ç¤ºè¯¥ `yaml` çš„ä½œç”¨ï¼‰

```bash
# é€’å½’åœ°åˆ›å»ºæ–‡ä»¶å¤¹
mkdir -p /home/docker-compose/nginx
# åˆ›å»º nginx-docker-compose.yaml
touch /home/docker-compose/nginx/nginx-docker-compose.yaml
```

ä½ ä¸å¿…æ–°å»º `data` æ–‡ä»¶å¤¹ï¼Œå› ä¸ºåœ¨å¯åŠ¨åä¼šè‡ªåŠ¨ç”Ÿæˆï¼Œæ‰€ä»¥å±•ç¤ºå¿½ç•¥ä¹‹

![2-where-is-nginx-docker-compose](./assets/2-where-is-nginx-docker-compose.png)

ä¹‹åä¸å†å±•ç¤ºå‘½ä»¤è¡Œæ–°å»ºæ–‡ä»¶å¤¹å’Œæ–‡ä»¶çš„æ–¹å¼ï¼Œå› ä¸ºç”¨ä¸€äº› FTP å·¥å…·å¯èƒ½æ›´é€‚åˆï¼Œä¾‹å¦‚ XFTP ç­‰ã€‚

åœ¨ `nginx-docker-compose.yaml` æ–‡ä»¶ä¸­è¾“å…¥ä¸€ä¸‹å†…å®¹: 

```yaml
version: '3.8'
services:
  nginx:
    image: nginx:1.23.3
    container_name: nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./data/conf/conf.d:/etc/nginx/conf.d
      - ./data/conf/nginx.conf:/etc/nginx/nginx.conf
      - ./data/conf/ssl:/etc/nginx/ssl
      - ./data/logs:/var/log/nginx
      - ./data/www:/usr/share/nginx/html
    networks:
      - nginx_all_in_one
networks:
  nginx_all_in_one:
    external: true
```

è¿™é‡Œè§£é‡Šä¸€ä¸‹ Docker-Compose é…ç½®æ–‡ä»¶ä¸­ç»å¸¸å‡ºç°çš„å­—æ®µä»¥åŠé‡Šä¹‰ï¼Œåæ–‡å°†ä¸å†èµ˜è¿°

|        å­—æ®µ        |   è§£é‡Š   | å¤‡æ³¨                                                         |
| :----------------: | :------: | ------------------------------------------------------------ |
|      `image`       |   é•œåƒ   | æ­¤åçš„é•œåƒéƒ½æŒ‡å®šç‰ˆæœ¬å·ï¼Œå¯è‡ªè¡Œå‡çº§æ–°ç‰ˆï¼Œä½†ä¸ä¿è¯èƒ½é€‚åº”æ–°ç‰¹æ€§ |
|      `ports`       | ç«¯å£æš´éœ² | `ports` æš´éœ²ç»™å®¿ä¸»æœºï¼Œè€Œ `expose` ä»…æš´éœ²ç»™åŒä¸€å±€åŸŸç½‘çš„å…¶ä»–å®¹å™¨ |
|     `valumes`      |   æŒ‚è½½   | åœ¨å½“å‰ç›®å½•ä¸‹ä¿å­˜ `Nginx` æ•°æ®ä»¥å®ç°æŒä¹…åŒ–                    |
|     `networks`     |   ç½‘ç»œ   | å¯é€‰æ‹©å¤šä¸ªç½‘ç»œï¼Œæ­¤å¤„å°† Nginx è¿å…¥ `nginx_all_in_one` ç½‘ç»œä¸­  |
| `nginx_all_in_one` | ç½‘ç»œåç§° | æ­¤å¤„ `external: true` è¡¨ç¤ºè¯¥ç½‘ç»œå·²ç»åˆ›å»º                     |

å†æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å¯åŠ¨ `Nginx`

```bash
# ç¡®ä¿è¿›å…¥åˆ° "nginx-docker-compose.yaml" åŒçº§ç›®å½•
cd /home/docker-compose/nginx
# ä½¿ç”¨ docker-compose å¯åŠ¨ nginx
# -f è¡¨ç¤ºæŒ‡å®š yaml é…ç½®æ–‡ä»¶
# -d è¡¨ç¤ºåå°è¿è¡Œï¼Œä¸éœ€è¦æ˜¾ç¤ºæ—¥å¿—åˆ°æ§åˆ¶å°ä¸Š
# up è¡¨ç¤ºå¯åŠ¨
docker-compose -f nginx-docker-compose.yaml up -d
```

è¿™é‡Œæ¨èä½ å®‰è£… `Portainer`ï¼Œä¸€æ¬¾ Docker å¯è§†åŒ–ç®¡ç†å·¥å…·ï¼Œæ–¹ä¾¿ä½ æŸ¥çœ‹ Docker è¿è¡ŒçŠ¶æ€

å®‰è£…å¥½åï¼Œä½ åº”è¯¥ä¼šåœ¨ `/home/docker-compose/nginx/data` ä¸‹çœ‹åˆ°å¦‚ä¸‹æ–‡ä»¶å¤¹

![2-after-exec-nginx-docker-compose](./assets/2-after-exec-nginx-docker-compose.png)



##  2.5 é…ç½® Nginx åä»£ & SSL è¯ä¹¦

### 2.5.1 å®‰è£… SSL è¯ä¹¦

åœ¨ "2.3 è·å– SSL è¯ä¹¦" ä¸­ï¼Œæˆ‘ä»¬ç”³è¯·äº†å››ä¸ªåŸŸåçš„ SSL è¯ä¹¦ï¼Œç°åœ¨æˆ‘ä»¬æŠŠä»–ä¸‹è½½ä¸‹æ¥

![2-download-ssl](./assets/2-download-ssl.png)

ä¸€å®šè¦é€‰æ‹©å¯¹åº”çš„ `Nginx` è¯ä¹¦ï¼Œå¯ä»¥å…ˆä¸‹è½½åˆ°æœ¬åœ°ï¼Œç„¶åå†ç”¨è­¬å¦‚ `XFTP` å·¥å…·ä¸Šä¼ åˆ°æœåŠ¡å™¨

![2-download-ssl-for-nginx](./assets/2-download-ssl-for-nginx.png)

å°† 4 ä¸ªåŸŸåçš„ 8 ä¸ªè¯ä¹¦æ–‡ä»¶æ”¾åˆ° `/home/docker-compose/nginx/data/conf/ssl/` æ–‡ä»¶å¤¹ä¸‹ï¼Œåˆ†åˆ«æ˜¯: 

- **\*.example.com.key**: ç§é’¥æ–‡ä»¶ï¼Œç”¨äºè§£å¯†é€šè¿‡å…¬é’¥åŠ å¯†çš„ä¿¡æ¯ã€‚
- **\*.example.com_bundle.crt**: è¯ä¹¦åŒ…æ–‡ä»¶ï¼Œé€šå¸¸åŒ…æ‹¬ä¸€ä¸ªæˆ–å¤šä¸ªè¯ä¹¦ã€‚

![2-ssl-file-list](./assets/2-ssl-file-list.png)

### 2.5.2 é…ç½®åå‘ä»£ç†è§„åˆ™

åœ¨ `/home/docker-compose/nginx/data/conf/conf.d/` æ–‡ä»¶å¤¹ä¸‹æ–°å»ºä»¥ä¸‹æ–‡ä»¶ï¼Œä¸‹é¢å°†ä¾æ¬¡ç»™å‡ºå››ä¸ªæ–‡ä»¶çš„å†…å®¹

**æ³¨æ„â€¼: è®°å¾—å°†é…ç½®æ–‡ä»¶ä¸­çš„æ‰€æœ‰ `*.example.com` æ¢æˆä½ è‡ªå·±çš„åŸŸå**

![2-nginx-config-file-list](./assets/2-nginx-config-file-list.png)

(1) minio-admin.conf

```nginx
server {
    listen 80;
    listen 443 ssl;
    charset utf-8;
    server_name minio-admin.example.com;

    #è¯ä¹¦æ–‡ä»¶åç§°
    ssl_certificate ssl/minio-admin.example.com_bundle.crt; 
    #ç§é’¥æ–‡ä»¶åç§°
    ssl_certificate_key ssl/minio-admin.example.com.key; 
    ssl_session_timeout 5m;
    #è¯·æŒ‰ç…§ä»¥ä¸‹åè®®é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3; 
    #è¯·æŒ‰ç…§ä»¥ä¸‹å¥—ä»¶é…ç½®ï¼Œé…ç½®åŠ å¯†å¥—ä»¶ï¼Œå†™æ³•éµå¾ª openssl æ ‡å‡†ã€‚
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE; 
    ssl_prefer_server_ciphers on;
    
    # Allow special characters in headers
    ignore_invalid_headers off;
    # Allow any size file to be uploaded.
    # Set to a value such as 1000m; to restrict file size to a specific value
    client_max_body_size 100m;
    # Disable buffering
    proxy_buffering off;
    proxy_request_buffering off;

    location / {
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-NginX-Proxy true;

        # This is necessary to pass the correct IP to be hashed
        real_ip_header X-Real-IP;

        proxy_connect_timeout 300;

        # To support websockets in MinIO versions released after January 2023
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        chunked_transfer_encoding off;
        
        proxy_pass http://minio:9001;
    }
}
```



(2) minio.conf

```nginx
server {
    listen 80;
    listen 443 ssl;
    charset utf-8;
    server_name minio.example.com;

    #è¯ä¹¦æ–‡ä»¶åç§°
    ssl_certificate ssl/minio.example.com_bundle.crt; 
    #ç§é’¥æ–‡ä»¶åç§°
    ssl_certificate_key ssl/minio.example.com.key; 
    ssl_session_timeout 5m;
    #è¯·æŒ‰ç…§ä»¥ä¸‹åè®®é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3; 
    #è¯·æŒ‰ç…§ä»¥ä¸‹å¥—ä»¶é…ç½®ï¼Œé…ç½®åŠ å¯†å¥—ä»¶ï¼Œå†™æ³•éµå¾ª openssl æ ‡å‡†ã€‚
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE; 
    ssl_prefer_server_ciphers on;
   
    # Allow special characters in headers
    ignore_invalid_headers off;
    # Allow any size file to be uploaded.
    # Set to a value such as 1000m; to restrict file size to a specific value
    client_max_body_size 100m;
    # Disable buffering
    proxy_buffering off;
    proxy_request_buffering off;

    location / {
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 300;
        # Default is HTTP/1, keepalive is only enabled in HTTP/1.1
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        chunked_transfer_encoding off;

        proxy_pass http://minio:9000;
    }

}
```



(3) outline.conf

```nginx
server {
    listen 80;
    listen 443 ssl;
    charset utf-8;
    server_name outline.example.com;

    #è¯ä¹¦æ–‡ä»¶åç§°
    ssl_certificate ssl/outline.example.com_bundle.crt; 
    #ç§é’¥æ–‡ä»¶åç§°
    ssl_certificate_key ssl/outline.example.com.key; 
    ssl_session_timeout 5m;
    #è¯·æŒ‰ç…§ä»¥ä¸‹åè®®é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3; 
    #è¯·æŒ‰ç…§ä»¥ä¸‹å¥—ä»¶é…ç½®ï¼Œé…ç½®åŠ å¯†å¥—ä»¶ï¼Œå†™æ³•éµå¾ª openssl æ ‡å‡†ã€‚
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE; 
    ssl_prefer_server_ciphers on;

    location / {
        proxy_pass http://outline:3000/;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;proxy_set_header Host $host;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Scheme $scheme;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_redirect off;
    }

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   html;
    }

}
```



(4) sso.conf

```nginx
server {
    listen 80;
    #SSL è®¿é—®ç«¯å£å·ä¸º 443
    listen 443 ssl;
    charset utf-8;
    server_name sso.example.com;

    #è¯ä¹¦æ–‡ä»¶åç§°
    ssl_certificate ssl/sso.example.com_bundle.crt; 
    #ç§é’¥æ–‡ä»¶åç§°
    ssl_certificate_key ssl/sso.example.com.key; 
    ssl_session_timeout 5m;
    #è¯·æŒ‰ç…§ä»¥ä¸‹åè®®é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3; 
    #è¯·æŒ‰ç…§ä»¥ä¸‹å¥—ä»¶é…ç½®ï¼Œé…ç½®åŠ å¯†å¥—ä»¶ï¼Œå†™æ³•éµå¾ª openssl æ ‡å‡†ã€‚
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE; 
    ssl_prefer_server_ciphers on;
   
    location / {
        proxy_pass http://keycloak:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   html;
    }

}
```

**ã€ä»¥ä¸‹å†…å®¹ä¸ºé…ç½®é¡¹çš„å‡ºå¤„ä¸é…ç½®å‡ºé”™å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼Œå¯é€‰æ‹©æ€§é˜…è¯»ã€‘**

**proxy_pass çš„è§£é‡Š:** 

æ‰€æœ‰ `host` éƒ½ç”¨äº†ç›¸å¯¹åº”å®¹å™¨çš„åç§°ï¼Œè¿™å…¶å®æ˜¯minioã€outlineã€ssoéƒ½è¿å…¥äº† `nginx_all_in_one` çš„è™šæ‹Ÿå±€åŸŸç½‘ï¼ŒåŒæ—¶è¯¥è™šæ‹Ÿå±€åŸŸç½‘åˆé…ç½®äº†åŸŸåè½¬æ¢å…³ç³»ï¼Œå¯ä»¥é€šè¿‡ `containner_name` ç´¢å¼•åˆ°ç›¸å¯¹åº”çš„ å±€åŸŸç½‘IP



**outline.conf é…ç½®é¡¹:**

æ¥æºäº Outline çš„å®˜æ–¹æ–‡æ¡£ [Outline/Configuration/Nginx](https://docs.getoutline.com/s/hosting/doc/nginx-6htaRboR57)

å¦‚æœä¸é…ç½®ï¼Œé‚£ä¹ˆåœ¨ç™»é™†æˆåŠŸåï¼ˆKeycloakæ˜¾ç¤ºæ ¡éªŒæˆåŠŸï¼‰å´è¢«å‘ŠçŸ¥ `èº«ä»½éªŒè¯å¤±è´¥ï¼Œæˆ‘ä»¬æ— æ³•è®©ä½ ç™»é™†`



**minio.conf é…ç½®é¡¹**: 

æ¥æºäº MinIO çš„å®˜æ–¹æ–‡æ¡£ [Integrations/Configure NGINX Proxy for MinIO Server](http://minio.org.cn/docs/minio/linux/integrations/setup-nginx-proxy-with-minio.html)ã€‚

å¦‚æœä¸é…ç½®ï¼Œå°†æ— æ³•æ­£å¸¸ç™»å½• Admin ç«¯ï¼Œä¹Ÿæ— æ³•ä¸Šä¼ æ–‡ä»¶



**sso.conf é…ç½®é¡¹**: 

æ¥æºäº Keycloak çš„å®˜æ–¹æ–‡æ¡£ [Guides/Server/Using a reverse proxy](https://www.keycloak.org/server/reverseproxy)

Keycloak çš„æŸäº›åŠŸèƒ½ä¾èµ–äºè¿™æ ·ä¸€ä¸ªå‡è®¾ï¼Œå³è¿æ¥åˆ° Keycloak çš„ HTTP è¯·æ±‚çš„è¿œç¨‹åœ°å€æ˜¯å®¢æˆ·ç«¯æœºå™¨çš„çœŸå® IP åœ°å€ã€‚

åœ¨è¾¹ç¼˜æˆ–é‡æ–°åŠ å¯†ä»£ç†æ¨¡å¼ä¸‹ï¼ŒKeycloak å°†è§£æä»¥ä¸‹æ ‡å¤´ï¼Œå¹¶æœŸæœ›åå‘ä»£ç†è®¾ç½®å®ƒä»¬: 

- æŒ‰ç…§ RFC7239 çš„ Forwarded
- éæ ‡å‡†çš„ X-Forwarded
- éæ ‡å‡†çš„ X-Forwarded-*ï¼Œä¾‹å¦‚ X-Forwarded-Forã€X-Forwarded-Protoã€X-Forwarded-Host å’Œ X-Forwarded-Port

### 2.5.3 å¯¼å…¥åˆ° Nginx é…ç½®

åœ¨ `/home/docker-compose/nginx/data/conf/` ç›®å½•ä¸‹ï¼Œä½ åº”è¯¥å¯ä»¥çœ‹åˆ° `nginx.conf` æ–‡ä»¶ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦é…ç½®è¯¥æ–‡ä»¶ï¼Œå¼•å…¥ `./conf.d/` ä¸‹çš„æ‰€æœ‰é…ç½®æ–‡ä»¶

![2-whereis-nginxconf](./assets/2-whereis-nginxconf.png)

è¿™æ˜¯ `nginx.conf` çš„å†…å®¹: 

```nginx
user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  /var/log/nginx/access.log  main;
    sendfile        on;
    keepalive_timeout  65;
    gzip  on;
    # å¯¼å…¥æ‰€æœ‰é…ç½®æ–‡ä»¶
    include /etc/nginx/conf.d/*;
}
```



### 2.5.4 å¯ç”¨æœ€æ–°é…ç½®

ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›å…¥åˆ° Nginx çš„å®¹å™¨å†…ï¼Œå¹¶åˆ·æ–°é…ç½®: 

```bash
# è¿›å…¥ Docker å®¹å™¨
docker exec -it nginx /bin/bash

# æ ¡éªŒé…ç½®
nginx -t
# å¦‚æœè¾“å‡ºä»¥ä¸‹å†…å®¹ï¼Œå°±è¯´æ˜é…ç½®æ–‡ä»¶æ ¡éªŒæˆåŠŸ
# nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
# nginx: configuration file /etc/nginx/nginx.conf test is successful

# å†åˆ·æ–° Nginx é…ç½®
nginx -s reload

# æ²¡ä»€ä¹ˆé—®é¢˜çš„è¯ï¼Œå¯ä»¥è¾“å…¥ exit é€€å‡º
exit
```

åˆ°æ­¤ä¸ºæ­¢ï¼Œä½ å·²ç»å®Œæˆäº† "1. æ¶æ„å›¾" ä¸­çš„å¤§è‡´æ¡†æ¶äº†ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬ç»§ç»­éƒ¨ç½²å¦å¤–å‡ ä¸ªåº”ç”¨å§ ğŸš€ğŸ› ï¸



# 3. PostgreSQL éƒ¨ç½²

## 3.1 æ¦‚è¿°

PostgreSQL æ˜¯ä¸€ä¸ªå…³ç³»å‹æ•°æ®åº“ï¼Œæœªæ¥æˆ‘ä»¬çš„ Outline å’Œ Keycloak å°†ä½¿ç”¨è¯¥æ•°æ®åº“å­˜å‚¨æ•°æ®



## 3.2 å·²æœ‰ PostgreSQL æœåŠ¡

å¦‚æœä½ æœåŠ¡å™¨å·²ç»éƒ¨ç½²äº† PostgreSQLï¼Œå¹¶ä¸”ä¹Ÿæ˜¯åŸºäº Docker éƒ¨ç½²çš„ï¼Œé‚£ä¹ˆå¯ä»¥è·³è¿‡ä¸‹ä¸€èŠ‚

ä½ å¯ä»¥ç›´æ¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤è®© PostgreSQL æ¥å…¥ `nginx_all_in_one` ç½‘ç»œï¼ˆä½ éœ€è¦å°† `name_of_postgres_container` æ¢æˆå¯¹åº”çš„å®¹å™¨åï¼‰

```bash
docker network connect nginx_all_in_one name_of_postgres_container
```



å¦‚æœä½ å°šæœªéƒ¨ç½²æˆ–å¹¶éä½¿ç”¨ Docker éƒ¨ç½²çš„ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘å†éƒ¨ç½²ä¸€ä¸ª PostgreSQL æˆ–è€…å…ˆå¯¼å‡ºæ‰€æœ‰æ•°æ®ï¼Œå†åˆ‡æ¢åˆ° Docker-Compose éƒ¨ç½²ã€‚



## 3.3 ä½¿ç”¨ Docker-Compose éƒ¨ç½² PostgreSQL

åœ¨ `/home/docker-compose/postgres/` ä¸‹åˆ›å»º `postgres-docker-compose.yaml`

![3-where-is-postgres-docker-compose](./assets/3-where-is-postgres-docker-compose.png)

å¹¶å†™å…¥ä»¥ä¸‹å†…å®¹: 

å…³äº `expose`: è¿™é‡Œå°† PostgreSQL æ¥å…¥äº† `nginx_all_in_one` ç½‘ç»œï¼Œè¯¥ç½‘ç»œä¸‹çš„å®¹å™¨åªèƒ½äº’ç›¸è®¿é—®å¯¹åº”å®¹å™¨çš„ expose çš„ç«¯å£ã€‚æ‰€ä»¥è¿™é‡Œå¿…é¡»è®¾ç½®ï¼Œå¦åˆ™ Outline å’Œ Keycloak å°†æ— æ³•è®¿é—® `http://postgres12:5432` å®ç°æ•°æ®æŒä¹…åŒ–

```yaml
version: '3.8'
services:
  postgres12:
    image: postgres:12.10
    container_name: postgres12
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: password
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - ./data:/var/lib/postgresql/data
    expose:
      - 5432
    networks:
        - nginx_all_in_one
networks:
  nginx_all_in_one:
    external: true
```

**æ³¨æ„â€¼: ä½ éœ€è¦ä¿®æ”¹ `POSTGRES_PASSWORD: password` ä½œä¸ºæ•°æ®åº“çš„å¯†ç **

ç”±äºåæ–‡éœ€è¦è®¾ç½®çš„å¯†ç ç‰¹åˆ«å¤šï¼Œè€Œè¿™äº›å¯†ç å·²ç»é…ç½®å…¶å®å°±ä¸ä¼šå†æ‰‹åŠ¨è¾“å…¥äº†ï¼Œè€Œä¸”å¯†ç éƒ½ä¿å­˜åœ¨äº† `*-docker-compose.yaml` æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥æˆ‘å»ºè®®ç›´æ¥ä½¿ç”¨éšæœºå­—ç¬¦ä¸²ç”Ÿæˆå¹¶å¡«å†™

æˆ‘ä½¿ç”¨çš„æ˜¯ [Avast éšæœºå¯†ç ç”Ÿæˆå™¨](https://www.avast.com/zh-cn/random-password-generator#pc)ï¼Œä½†ç”±äºæ˜¯åœ¨çº¿å·¥å…·ï¼Œæˆ‘è¿˜æ˜¯ä¸å¤ªæ”¾å¿ƒï¼Œä»¥åæ¥è§¦åˆ°æ›´å¥½çš„å†æ›´æ–°(Mark as TODO)

æ­¤å¤–å†å»ºè®®å°½é‡åˆ«ç”¨ç‰¹æ®Šå­—ç¬¦ï¼Œå°±`å°å†™å­—æ¯`+`æ•°å­—`+`30+ä½`çš„éšæœºå­—ç¬¦ä¸²å¯†ç åº”è¯¥å¾ˆå®‰å…¨å§~æœ‰æ—¶å€™ç‰¹æ®Šå­—ç¬¦ä¼šè¢«å½“åšå‘½ä»¤ç¬¦æˆ–è€…è½¬ä¹‰å­—ç¬¦ï¼Œå®¹æ˜“å‡ºç°ä¹±ä¸ƒå…«ç³Ÿçš„BUG

æ¥ç€ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼Œåˆ›å»º PostgreSQL

```bash
# ç¡®ä¿è¿›å…¥åˆ° "postgres-docker-compose.yaml" åŒçº§ç›®å½•
cd /home/docker-compose/postgres
# ä½¿ç”¨ docker-compose å¯åŠ¨ redis
docker-compose -f postgres-docker-compose.yaml up -d
```

## 3.4 åˆ›å»ºç”¨æˆ·ä¸æ•°æ®åº“

éœ€è¦åˆ†åˆ«ä¸º Outline å’Œ Keycloak é¡¹ç›®åˆ†é…ä¸€ä¸ªè´¦å·å’Œç›¸å…³æ•°æ®åº“

**æ³¨æ„â€¼: ä½ éœ€è¦ä¿®æ”¹ `password_of_*_user` ä½œä¸ºæ•°æ®åº“çš„å¯†ç **

```postgresql
# è¿›å…¥ PostgreSQL æ•°æ®åº“å‘½ä»¤è¡Œ
docker exec -it --user postgres postgres12 psql -U postgres

# åˆ›å»ºç”¨æˆ·
CREATE USER outline WITH PASSWORD 'password_of_outline_user';
CREATE USER keycloak WITH PASSWORD 'password_of_keycloak_user';

# åˆ›å»ºæ•°æ®åº“
CREATE DATABASE outline OWNER outline;
CREATE DATABASE outline_test OWNER outline;
CREATE DATABASE keycloak OWNER keycloak;

# é€€å‡ºå‘½ä»¤è¡Œ
\q
```



# 4. Redis éƒ¨ç½²

## 4.1 æ¦‚è¿°

Redis æ˜¯ä¸€ä¸ªéå…³ç³»å‹æ•°æ®åº“ï¼Œæ˜¯åŸºäºå†…å­˜çš„æ•°æ®è¯»å†™æ–¹å¼ï¼Œæ¯” Postgres å“åº”é€Ÿåº¦å¿«ï¼Œä½†ä»ç„¶éœ€è¦ PostgreSQL å®Œæˆæ•°æ®æŒä¹…åŒ–ã€‚äºŒè€…ç›¸è¾…ç›¸æˆã€‚

åœ¨ Outline ä¸­ï¼Œä½¿ç”¨ Redis å®ç°ç¼“å­˜ã€æ¶ˆæ¯é˜Ÿåˆ—ã€ä¼šè¯å­˜å‚¨ã€å®æ—¶åä½œç­‰åŠŸèƒ½ã€‚



## 4.2 ä½¿ç”¨ Docker-Compose éƒ¨ç½² Redis

åœ¨ `/home/docker-compose/redis/` ä¸‹ï¼Œåˆ›å»º `redis-docker-compose.yaml`

![4-where-is-redis-docker-compose](./assets/4-where-is-redis-docker-compose.png)

è¯¥æ–‡ä»¶å†…å®¹å¦‚ä¸‹: 

**æ³¨æ„â€¼: ä½ éœ€è¦ä¿®æ”¹ `password_of_redis` ä½œä¸º Redis çš„å¯†ç **

```yaml
version: '3.8'
services:
  redis:
    image: redis:7.0.8
    container_name: redis
    restart: unless-stopped
    command: 
      --requirepass "password_of_redis"
    expose:
      - 6379
    volumes:
      - ./data:/data
    privileged: true
    networks:
      - nginx_all_in_one
networks:
  nginx_all_in_one:
    external: true
```

æ¥ç€ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºè¯¥å®¹å™¨

```bash
# ç¡®ä¿è¿›å…¥åˆ° "redis-docker-compose.yaml" åŒçº§ç›®å½•
cd /home/docker-compose/redis
# ä½¿ç”¨ docker-compose å¯åŠ¨ redis
docker-compose -f redis-docker-compose.yaml up -d
```



# 5. Keycloak éƒ¨ç½²

## 5.1 æ¦‚è¿°

Keycloak æ˜¯ä¸€ä¸ªå¯ä»¥æä¾› Outline æ‰€éœ€çš„ OIDC å•ç‚¹ç™»å½•æœåŠ¡ã€‚OIDCï¼ˆOpenID Connectï¼‰æ˜¯ä¸€ç§åŸºäº OAuth 2.0 åè®®çš„èº«ä»½å±‚ï¼Œé€šè¿‡å…è®¸å®¢æˆ·ç«¯éªŒè¯ç”¨æˆ·èº«ä»½å¹¶è·å–åŸºæœ¬ä¸ªäººä¿¡æ¯ï¼Œå®ç°è·¨ç³»ç»Ÿçš„å•ä¸€ç™»å½•ã€‚

è™½ç„¶ Outline æ”¯æŒå¤šç§ OIDC åœ¨çº¿æœåŠ¡ï¼Œä¾‹å¦‚ Google Workspace ç­‰ï¼Œä½†å¤§å¤šæ•°æ˜¯æ”¶è´¹ã€éœ€è¦ä¼ä¸šé‚®ç®±çš„ã€‚æŠ›å¼€ä»·æ ¼é—¨æ§›ä¸è°ˆï¼Œè´¦æˆ·æ•°æ®å­˜å‚¨åœ¨äº‘ç«¯æ€»è§‰å¾—ä¼šäº§ç”Ÿä¾èµ–æ„Ÿï¼Œæ‰€ä»¥è¿˜æ˜¯é€‰æ‹©äº†æœ¬åœ° OIDC æœåŠ¡ã€‚

Keycloak æ˜¯ä¸€ä¸ªéå¸¸åºå¤§ä¸”å¥å…¨çš„ OIDC æœåŠ¡ï¼Œæ‰€ä»¥éƒ¨ç½²èµ·æ¥ä¹Ÿæ˜¯ç›¸å½“å›°éš¾ï¼Œè¿™å‡ ä¹å æ®äº†æˆ‘æ•´ä¸ªéƒ¨ç½²æ—¶é—´çš„ 1/3ã€‚

ä¸‹é¢å°†è¯¦ç»†è¯´æ˜ Keycloak çš„éƒ¨ç½²æµç¨‹



## 5.2 ä½¿ç”¨ Docker-Compose éƒ¨ç½² Keycloak

åœ¨ `/home/docker-compose/keycloak/` ä¸‹ï¼Œåˆ›å»º `keycloak-docker-compose.yaml`

![5-where-is-keycloak-docker-compose](./assets/5-where-is-keycloak-docker-compose.png)

æ–‡ä»¶å†…å®¹å¦‚ä¸‹: 

```yaml
version: "3.8"
services:
  # keycloak
  keycloak:
    image: jboss/keycloak:15.0.2
    container_name: keycloak
    expose:
        - 8080
    volumes:
        - /etc/timezone:/etc/timezone
        - /etc/localtime:/etc/localtime
    environment:
        # åˆå§‹åŒ–å¯†ç 
        - KEYCLOAK_USER=admin
        - KEYCLOAK_PASSWORD=password_of_keycloak
        # DB
        - DB_VENDOR=postgres
        - DB_ADDR=postgres12
        - DB_PORT=5432
        - DB_DATABASE=keycloak
        - DB_USER=keycloak
        - DB_PASSWORD=password_of_keycloak_user
        # å¼€å¯åå‘ä»£ç†
        - PROXY_ADDRESS_FORWARDING=true
    labels:
        - "traefik.enable=true"
        - "traefik.docker.network=nginx_all_in_one"
        - "traefik.http.routers.halobug-sso.entrypoints=https"
        - "traefik.http.routers.halobug-sso.tls=true"
        - "traefik.http.routers.halobug-sso.rule=Host(`sso.example.com`)"
        - "traefik.http.services.halobug-sso.loadbalancer.server.scheme=http"
        - "traefik.http.services.halobug-sso.loadbalancer.server.port=8080"
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
    networks:
        - nginx_all_in_one
networks:
  nginx_all_in_one:
    external: true
```

éœ€è¦**æ›´æ”¹**çš„å­—æ®µæœ‰: 

- `password_of_keycloak`: Keycloak çš„å¯†ç ï¼Œæ˜¯æ–°å®šä¹‰çš„
- `password_of_keycloak_user`: åœ¨ PostgreSQL ä¸­å®šä¹‰çš„ Keycloak ç”¨æˆ·å¯†ç ï¼Œ**å·²ç»å®šä¹‰å¥½äº†çš„ï¼Œåˆ«å¤åˆ¶é”™äº†**
- `sso.example.com`: åœ¨ labels ä¸­ï¼Œè®°å¾—æ”¹æˆä½ è‡ªå·±çš„åŸŸå



éœ€è¦**æ³¨æ„**çš„å­—æ®µæœ‰: 

- `DB_ADDR=postgres12`: `postgres12` æ˜¯æˆ‘ä»¬åœ¨éƒ¨ç½² PostgreSQL æ—¶ `yaml` æ–‡ä»¶ä¸­ï¼Œ`container_name` å®šä¹‰çš„åç§°ã€‚å¦‚æœä½ ç”¨çš„åˆ«çš„åå­—æˆ–è€…ä»¥å‰å°±éƒ¨ç½²å¥½äº†ï¼Œä¸€å®šè¦æ£€æŸ¥æ˜¯ä»€ä¹ˆåå­—ï¼



**ä¸éœ€è¦æ›´æ”¹**çš„å­—æ®µæœ‰: ï¼ˆå®¹æ˜“è¢«è¯¯è§£çš„å­—æ®µï¼‰

- `expose:8080`: ä¸€èˆ¬ 8080 ç«¯å£æ—©å°±å…¶ä»–è½¯ä»¶è¢«å ç”¨äº†ï¼Œä½†è¿™é‡Œä¸éœ€è¦æ›´æ”¹ç«¯å£ï¼Œå› ä¸ºä»–åªä¼šå ç”¨è‡ªå·±å±€åŸŸç½‘ä¸‹çš„å±€åŸŸç½‘ IP çš„ 8080 ç«¯å£ã€‚æ‰€ä»¥è¯·æ”¾å¿ƒè®¾ç½®ã€‚

- `/etc/timezone:/etc/timezone`: è¿™é‡Œæ˜¯ç»‘å®šä¸»æœºçš„æ—¶åŒºåˆ°è™šæ‹Ÿä¸»æœºï¼Œå½“ç„¶ä½ éœ€è¦ç¡®ä¿ä½ ä¸»æœºæœ‰è¿™ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢è¿™ä¸ªå‘½ä»¤ç”Ÿæˆ

  - ```bash
    # å¦‚æœä¸å­˜åœ¨ï¼Œå°±ä¼šæŠ¥é”™
    ls /etc/timezone
    # åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„æ—¶åŒºï¼ˆè¾“å…¥qé€€å‡ºï¼‰
    timedatectl list-timezones
    # åœ¨åˆ—è¡¨ä¸­æ‰¾åˆ° "Asia/Shanghai" æˆ–ä½ æ‰€éœ€çš„å…¶ä»–ä¸­å›½æ—¶åŒº
    timedatectl set-timezone Asia/Shanghai
    # æ£€æŸ¥æ˜¯å¦ç”Ÿæ•ˆ
    timedatectl status
    ```


- `/etc/localtime:/etc/localtime`: `/etc/localtime` æ–‡ä»¶æ˜¯ä¸€ä¸ªé“¾æ¥åˆ°å®é™…æ—¶åŒºæ•°æ®æ–‡ä»¶çš„ç¬¦å·é“¾æ¥ã€‚å½“ä½ ä½¿ç”¨ `timedatectl` æˆ–å…¶ä»–æ—¶åŒºè®¾ç½®å·¥å…·æ›´æ”¹æ—¶åŒºæ—¶ï¼Œè¿™ä¸ªé“¾æ¥é€šå¸¸ä¼šè‡ªåŠ¨æ›´æ–°ã€‚

  - ```bash
    # é€‰æ‹©æ—¶åŒº: ç¡®å®šä½ æƒ³è¦è®¾ç½®çš„æ—¶åŒºã€‚ä¾‹å¦‚ï¼Œå¯¹äºä¸­å›½ä¸Šæµ·æ—¶åŒºï¼Œä½ å¯ä»¥ä½¿ç”¨ /usr/share/zoneinfo/Asia/Shanghai
    # åˆ›å»ºç¬¦å·é“¾æ¥: ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åˆ›å»ºæˆ–æ›´æ–° /etc/localtime çš„ç¬¦å·é“¾æ¥
    sudo ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime
    # éªŒè¯è®¾ç½®: ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ /etc/localtime æ˜¯å¦æ­£ç¡®é“¾æ¥åˆ°æ‰€éœ€çš„æ—¶åŒºæ–‡ä»¶
    ls -l /etc/localtime
    # æ£€æŸ¥ç³»ç»Ÿæ—¶åŒº: ä½ è¿˜å¯ä»¥ä½¿ç”¨ date å‘½ä»¤æ¥æ£€æŸ¥ç³»ç»Ÿæ—¶åŒºæ˜¯å¦æ­£ç¡®
    date
    # æ‰‹åŠ¨æ›´æ”¹ /etc/localtime æ–‡ä»¶å¯èƒ½ä¼šä¸ç³»ç»Ÿçš„æ—¶åŒºç®¡ç†å·¥å…·å†²çªã€‚å»ºè®®ä½¿ç”¨ timedatectl æˆ–ä½ çš„å‘è¡Œç‰ˆæ¨èçš„å·¥å…·æ¥æ›´æ”¹æ—¶åŒºï¼Œä»¥ç¡®ä¿æ‰€æœ‰ç›¸å…³çš„è®¾ç½®éƒ½æ­£ç¡®æ›´æ–°
    ```



æœ€åçš„æœ€åï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤éƒ¨ç½² Keycloak

```bash
# ç¡®ä¿è¿›å…¥åˆ° "keycloak-docker-compose.yaml" åŒçº§ç›®å½•
cd /home/docker-compose/keycloak
# ä½¿ç”¨ docker-compose å¯åŠ¨ keycloak
docker-compose -f keycloak-docker-compose.yaml up -d
```



## 5.3 é…ç½® Outline çš„ OIDC æœåŠ¡

æ¥ä¸‹æ¥å°±æ˜¯ä½¿ç”¨ Keycloak é…ç½® Outline çš„ OIDC æœåŠ¡



### 5.3.1 ç™»é™†

æ‰“å¼€ `sso.example.com`ï¼Œä¼šè‡ªåŠ¨è·³è½¬è‡³ `sso.example.com/auth/`

è¿›å…¥å·¦è¾¹çš„ **Administration Console**

![5-use-keycloak-01](./assets/5-use-keycloak-01.png)

è¾“å…¥åˆšåˆšå®šä¹‰çš„ `password_of_keycloak`ï¼Œç™»é™†

![5-use-keycloak-02](./assets/5-use-keycloak-02.png)



### 5.3.2 åˆ›å»º Outline Realm

åˆ›å»ºä¸€ä¸ªæ–°çš„ Realmï¼Œè¾“å…¥åç§° `outline`ï¼ˆæ³¨æ„æ˜¯å°å†™ï¼‰

æˆ‘è¿™é‡Œå·²ç»åˆ›å»ºäº† Outline çš„ Realmï¼Œå¯ä»¥çœ‹åˆ° Select Realm ä¸‹å…±æœ‰ä¸¤ä¸ª Realmï¼Œç´§æ¥ç€é€‰ä¸­ Outline çš„ Realm

![5-use-keycloak-03](./assets/5-use-keycloak-03.png)



### 5.3.3 åˆ›å»º Outline Client

åˆ›å»ºä¸€ä¸ª Client

![5-use-keycloak-04](./assets/5-use-keycloak-04.png)

æ³¨æ„ Root URL åº”è¯¥æ˜¯ä½ è‡ªå·±çš„åŸŸå

![5-use-keycloak-05](./assets/5-use-keycloak-05.png)



### 5.3.4 é…ç½® Outline Client

ä¹‹åè‡ªåŠ¨è¿›å…¥åˆ°è¯¥ Client çš„è®¾ç½®ç•Œé¢ï¼Œéœ€è¦ä¿®æ”¹ä»¥ä¸‹å­—æ®µ

![5-use-keycloak-06](./assets/5-use-keycloak-06.png)

æ³¨æ„åˆ«å¿˜äº† `Valid Redirect URIs` å­—æ®µä¸­çš„åŸŸååé¢æœ‰ **`/*`**

![5-use-keycloak-07](./assets/5-use-keycloak-07.png)

æœ€åä¿å­˜

![5-use-keycloak-08](./assets/5-use-keycloak-08.png)

ä¿å­˜ä¹‹åä¸Šæ–¹æ–°æ·»äº†ä¸€ä¸ªé€‰é¡¹å¡ `Credentials`ï¼Œè¿™é‡Œå¯ä»¥è·å– Outline æ‰€éœ€çš„ `OIDC_CLIENT_SECRET`ã€‚è¿™é‡Œå…ˆè®°ä¸€ä¸‹ï¼Œåé¢ä¼šç”¨åˆ°çš„ã€‚

![5-use-keycloak-09](./assets/5-use-keycloak-09.png)



### 5.3.5 åˆ›å»º Outline Client Role

æ¥ç€ä¸º Outline Realm åˆ›å»ºä¸€ä¸ªç”¨æˆ·ç»„ï¼Œè¯¥ç”¨æˆ·ç»„ç”¨æ¥æˆæƒå“ªäº›ç”¨æˆ·å¯ä»¥è®¿é—® Outlineï¼ˆè¯·å¿½ç•¥æˆ‘å·²ç»åˆ›å»ºäº† `outline-user`ï¼‰

![5-use-keycloak-10](./assets/5-use-keycloak-10.png)

è¾“å…¥åç§° `outline-user`ï¼Œå½“ç„¶è¿™ä¸ªæ˜¯è‡ªå®šä¹‰çš„ï¼Œä½ å¯ä»¥å–å…¶ä»–åå­—

![5-use-keycloak-11](./assets/5-use-keycloak-11.png)

### 5.3.6 åˆ›å»º Outline User

ç´§æ¥ç€åˆ›å»ºéœ€è¦è®¿é—® Outline çš„ç”¨æˆ·

![5-use-keycloak-12](./assets/5-use-keycloak-12.png)

è¿™é‡Œæ³¨æ„ Emailã€First Nameã€Last Name å°½é‡ä¸è¦ç•™ç©ºå§ï¼Œæˆ‘ç•™ç©ºæ²¡æœ‰æµ‹è¯•è¿‡ï¼Œæœ‰çœ‹è¿‡è¯´å› ä¸ºåç§°ä¸ºç©ºå¯¼è‡´æ— æ³•ç™»é™†çš„é—®é¢˜ï¼Œè®°å¾—è¿™ä¸ªå¯èƒ½çš„é—®é¢˜ï¼Œä¸ºä»¥å Debug æ‰¾åˆ°æ€è·¯ã€‚

![5-use-keycloak-13](./assets/5-use-keycloak-13.png)

ç„¶åä¸ºç”¨æˆ·è®¾ç½®å¯†ç ã€‚

æ³¨æ„: `Temporary` å­—æ®µæ„æ€æ˜¯å½“å‰è®¾ç½®çš„å¯†ç åªæ˜¯ä¸´æ—¶çš„ï¼Œç”¨æˆ·ç™»é™†æ—¶å°†è¦æ±‚ç”¨æˆ·æ›´æ”¹å¯†ç ã€‚è¿™ä¸ªå¯å¼€å¯ä¸å¼€ï¼Œçœ‹è‡ªå·±åº”ç”¨éœ€æ±‚ã€‚

![5-use-keycloak-16](./assets/5-use-keycloak-16.png)



### 5.3.7 æˆæƒ Outline User è®¿é—® Outline Client æƒé™

å†å°†ç”¨æˆ·åŠ å…¥åˆ°ä¹‹å‰çš„ `outline-user` çš„ Client Rolesï¼Œä»¥ä¾¿å¯ä»¥è®¿é—® Outline åº”ç”¨

![5-use-keycloak-14](./assets/5-use-keycloak-14.png)

è®¾ç½®å¥½ååº”è¯¥æ˜¯è¿™æ ·çš„

![5-use-keycloak-15](./assets/5-use-keycloak-15.png)



# 6. MinIO éƒ¨ç½²

## 6.1 æ¦‚è¿°

MinIO æä¾›é«˜æ€§èƒ½ã€ä¸ S3 å…¼å®¹çš„å¯¹è±¡å­˜å‚¨ç³»ç»Ÿï¼Œè®©ä½ è‡ªå·±èƒ½å¤Ÿæ„å»ºè‡ªå·±çš„äº‘å‚¨å­˜æœåŠ¡ã€‚

Outline ä½¿ç”¨ MinIO å®ç°å¯¹äºå›¾ç‰‡ã€è§†é¢‘ã€æ–‡ä»¶ç­‰å¯¹è±¡å­˜å‚¨ç®¡ç†ç³»ç»Ÿã€‚



## 6.2 ä½¿ç”¨ Docker-Compose éƒ¨ç½² MinIO

åœ¨ `/home/docker-compose/minio/` ä¸‹ï¼Œåˆ›å»º `minio-docker-compose.yaml`

![6-where-is-minio-docker-compose](./assets/6-where-is-minio-docker-compose.png)

`minio-docker-compose.yaml` çš„å†…å®¹å¦‚ä¸‹: 

```yaml
version: '3.8'
services:
  minio:
    image: minio/minio:RELEASE.2021-09-03T03-56-13Z
    container_name: minio
    restart: unless-stopped
    expose:
      - 9000
      - 9001
    environment:
      MINIO_ROOT_USER: "username_of_minio"
      MINIO_ROOT_PASSWORD: "password_of_minio"
      MINIO_REGION_NAME: "cn-outline-1"
      MINIO_BROWSER: "on"
      MINIO_SERVER_URL: "https://minio.example.com/"
      MINIO_BROWSER_REDIRECT_URL: "https://minio-admin.example.com/"
    volumes:
      - ./data:/data
    command: server /data --console-address ":9001"
    networks:
      - nginx_all_in_one
networks:
  nginx_all_in_one:
    external: true
```

éœ€è¦æ›´æ”¹çš„å­—æ®µå¦‚ä¸‹: 

- `username_of_minio`: ç”¨äºç™»é™† `minio-admin.example.com` çš„è´¦æˆ·åï¼Œå¯ä»¥è®¾ç½®æˆä¾‹å¦‚ç»å…¸çš„ adminã€root ä½†æ˜¯æˆ‘çœ‹å…¶ä»–äººçš„å®‰è£…æ•™ç¨‹éƒ½æ˜¯åå‘äºéšæœºå­—ç¬¦ä¸²ã€‚åœ¨å®˜æ–¹æ–‡æ¡£ä¸­ [Deploy MinIO: Single-Node Single-Drive](https://minio.org.cn/docs/minio/container/operations/install-deploy-manage/deploy-minio-single-node-single-drive.html#) ç»™å‡ºçš„ç¤ºä¾‹å¦‚ä¸‹: 

  - ```properties
    # MINIO_ROOT_USER and MINIO_ROOT_PASSWORD sets the root account for the MinIO server.
    # This user has unrestricted permissions to perform S3 and administrative API operations on any resource in the deployment.
    # Omit to use the default values 'minioadmin:minioadmin'.
    # MinIO recommends setting non-default values as a best practice, regardless of environment
    
    MINIO_ROOT_USER=myminioadmin
    MINIO_ROOT_PASSWORD=minio-secret-key-change-me
    ```

- `password_of_minio`: ç”¨äºç™»é™† `minio-admin.example.com` çš„è´¦æˆ·å¯†ç 
- `https://minio.example.com/`: ä¸€å®šè¦æ¢æˆè‡ªå·±çš„åŸŸå
- `https://minio-admin.example.com/`: ä¸€å®šè¦æ¢æˆè‡ªå·±çš„åŸŸå

éœ€è¦æ³¨æ„çš„å­—æ®µå¦‚ä¸‹: 

- `cn-outline-1`: è¿™ä¸ªæ˜¯è‡ªå®šä¹‰çš„ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±å–œå¥½å–åˆ«çš„åç§°
- `minio/minio:RELEASE.2021-09-03T03-56-13Z`: å¯è§è¯¥é•œåƒç‰ˆæœ¬æ¯”è¾ƒè€ï¼Œç”±äºæˆ‘åªåœ¨æ­¤ç‰ˆæœ¬åšäº†æµ‹è¯•ï¼Œæ‰€ä»¥ä¸ºäº†ä¸å‡ºæ„å¤–æ ‡æ˜äº†ä¸æˆ‘æœ¬åœ°ç¯å¢ƒç›¸åŒçš„ç‰ˆæœ¬ã€‚å¦‚æœä½ æƒ³ä½¿ç”¨æ–°ç‰ˆæœ¬ï¼Œé‚£ä¹ˆä½ åº”è¯¥è®¿é—®å®˜æ–¹å»äº†è§£æ–°ç‰¹æ€§å’Œå¯èƒ½éœ€è¦è®¾ç½®çš„å†…å®¹ã€‚

ä¸éœ€è¦æ›´æ”¹çš„å­—æ®µå¦‚ä¸‹: 

- `--console-address ":9001"`: åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼ŒMinIO å°†åœ¨æ¯æ¬¡æœåŠ¡å™¨å¯åŠ¨æ—¶ä¸º MinIO æ§åˆ¶å°é€‰æ‹©ä¸€ä¸ªéšæœºç«¯å£ã€‚è®¿é—® MinIO æœåŠ¡å™¨çš„æµè§ˆå™¨å®¢æˆ·ç«¯å°†è‡ªåŠ¨é‡å®šå‘åˆ° MinIO æ§åˆ¶å°çš„åŠ¨æ€é€‰æ‹©ç«¯å£ã€‚æˆ‘ä»¬è¿™é‡ŒæŒ‡å®šäº†ä¸€ä¸ªç«¯å£ï¼Œè¿™ä¹Ÿä¸ä¹‹å‰åœ¨ Nginx ä¸­è®¾ç½®çš„ `minio-admin.example.com` ç›¸å¯¹åº”



æœ€åï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤éƒ¨ç½² MinIO

```bash
# ç¡®ä¿è¿›å…¥åˆ° "minio-docker-compose.yaml" åŒçº§ç›®å½•
cd /home/docker-compose/minio
# ä½¿ç”¨ docker-compose å¯åŠ¨ minio
docker-compose -f minio-docker-compose.yaml up -d
```



## 6.3 é…ç½® Outline çš„ OSS æœåŠ¡

æ‰“å¼€ `minio-admin.example.com` æˆ–è€… `minio.example.com` (è‡ªåŠ¨è·³è½¬åˆ° admin åŸŸå)

![6-use-minio-01](./assets/6-use-minio-01.png)

åˆ›å»ºä¸€ä¸ªåä¸º `outline` çš„ Bucket

![6-use-minio-02](./assets/6-use-minio-02.png)

åˆ›å»ºä¸€ä¸ªç”¨æˆ·

- Access Key: Outline ç”¨äºè®¿é—® MinIO API çš„è®¿é—®å¯†é’¥ï¼Œä»»æ„å­—ç¬¦ä¸²ã€‚å¯ä»¥éšæœºç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå› ä¸ºä¹‹åæ˜¯å†™å…¥ Outline é…ç½®æ–‡ä»¶çš„ï¼Œå¹¶ä¸éœ€è¦è®°ä½ã€‚æˆ‘è¿™é‡Œæ˜¯ 16 ä½çš„ `å°å†™å­—æ¯`+`æ•°å­—`ï¼ŒæŸ¥èµ„æ–™è¯´æ˜¯ä¸å°‘äº 5  ä½æˆ– 3 ä½ã€‚
- Secret Key: Outline ç”¨äºè®¿é—® MinIO API çš„å¯†é’¥ï¼Œä»»æ„å­—ç¬¦ä¸²ã€‚å¯ä»¥éšæœºç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå› ä¸ºä¹‹åä¹Ÿæ˜¯å†™å…¥ Outline é…ç½®æ–‡ä»¶çš„ï¼Œå¹¶ä¸éœ€è¦è®°ä½ã€‚æˆ‘è¿™é‡Œæ˜¯ 64 ä½çš„ `å°å†™å­—æ¯`+`æ•°å­—`ï¼ŒæŸ¥èµ„æ–™è¯´æ˜¯ä¸å°‘äº 8 ä½ã€‚
- Assign Policies: å»ºè®®é€‰æ‹© `consoleAdmin` æˆ–è€… `readwirte`ï¼Œå³ Outline ç”¨è¿™ä¸ªå¯†é’¥å¯¹åçš„æƒé™ç­‰çº§ï¼Œæ­£å¸¸æ¥è¯´ `readwirte` å·²ç»èƒ½å¤Ÿå®Œæˆ å¢åˆ æŸ¥æ”¹ æ“ä½œäº†ã€‚

![6-use-minio-03](./assets/6-use-minio-03.png)

æœ€åå†åˆ›å»ºä¸€ä¸ªç»„ï¼Œå¹¶å‹¾é€‰åˆšåˆšåˆ›å»ºçš„é‚£ä¸ªç”¨æˆ·ã€‚

å½“ç„¶**ä¹Ÿå¯ä»¥ä¸åˆ›å»º**è¿™ä¸ªç»„ï¼Œç”¨æˆ·æ²¡æœ‰ä»»ä½•æƒé™ç®¡ç†çš„æƒ…å†µä¸‹æ˜¯å¯ä»¥è®¿é—®æ‰€æœ‰ Bucket çš„ï¼Œè¿™ä¸ªç»„ç›®å‰åªæ˜¯ç®€å•çš„åˆ†ä¸ªç±»ã€‚å¦‚æœåé¢ä½ è¿˜éœ€è¦æ¥å…¥å¤šä¸ªåº”ç”¨ã€å¤šä¸ªç”¨æˆ·ï¼Œæ­¤æ—¶ç”¨æˆ·ç»„å¯¹äºç®¡ç†æ¥è¯´å°±å¾ˆæ–¹ä¾¿äº†ã€‚

åç»­çš„æƒé™ç®¡ç†å°±ä¸ç»§ç»­è®¾ç½®äº†ï¼Œåˆ°æ­¤ä¸ºæ­¢å·²ç»æ»¡è¶³ Outline çš„éœ€æ±‚äº†ã€‚

![6-use-minio-04](./assets/6-use-minio-04.png)



# 7. Outline éƒ¨ç½²

## 7.1 æ¦‚è¿°

ç»ˆäºï¼Œåœ¨æ­å»ºå®Œæ‰€æœ‰çš„åœ°åŸºä¹‹åï¼Œå¯ä»¥å¼€å§‹æ­å»ºä¸Šå±‚å»ºç­‘: Outline

Outline å°†æ¥å…¥ `nginx_all_in_one` çš„ Docker Networkï¼Œä»¥æ­¤è®¿é—® PostgreSQL, Redis, Keycloak, MinIO æœåŠ¡



## 7.2 åˆ›å»º Outline é…ç½®æ–‡ä»¶

åœ¨ `/home/docker-compose/outline/` ä¸‹ï¼Œåˆ›å»º `outline-docker-compose.yaml` å’Œ `outline-docker.env`

![7-where-is-outline-docker-compose](./assets/7-where-is-outline-docker-compose.png)

è¿™é‡Œç›´æ¥ç»™å‡ºä¸¤ä¸ªæ–‡ä»¶çš„å†…å®¹ï¼Œä¹‹åæ–°å¼€ä¸€èŠ‚ä¸“é—¨è®²è§£æ¯ä¸ªå­—æ®µçš„ä½œç”¨ä»¥åŠæ³¨æ„äº‹é¡¹

(1) `outline-docker-compose.yaml`

```yaml
version: "3.8"
services:
  outline:
    image: docker.io/outlinewiki/outline:0.70.2
    container_name: outline
    env_file: ./outline-docker.env
    expose:
      - 3000
    networks:
      - nginx_all_in_one
networks:
  nginx_all_in_one:
    external: true
```

(2) `outline-docker.env`

```properties
# â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ REQUIRED â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“

NODE_ENV=production

# Generate a hex-encoded 32-byte random key. You should use `openssl rand -hex 32`
# in your terminal to generate a random value.
SECRET_KEY=secret_key

# Generate a unique random key. The format is not important but you could still use
# `openssl rand -hex 32` in your terminal to produce this.
UTILS_SECRET=utils_secret

# For production point these at your databases, in development the default
# should work out of the box.
DATABASE_URL=postgres://outline:password_of_outline_user@postgres12:5432/outline
DATABASE_URL_TEST=postgres://outline:password_of_outline_user@postgres12:5432/outline_test
DATABASE_CONNECTION_POOL_MIN=
DATABASE_CONNECTION_POOL_MAX=
# Uncomment this to disable SSL for connecting to Postgres
PGSSLMODE=disable

# For redis you can either specify an ioredis compatible url like this
REDIS_URL=redis://:password_of_redis@redis:6379
# or alternatively, if you would like to provide additional connection options,
# use a base64 encoded JSON connection option object. Refer to the ioredis documentation
# for a list of available options.
# Example: Use Redis Sentinel for high availability
# {"sentinels":[{"host":"sentinel-0","port":26379},{"host":"sentinel-1","port":26379}],"name":"mymaster"}
# REDIS_URL=ioredis://eyJzZW50aW5lbHMiOlt7Imhvc3QiOiJzZW50aW5lbC0wIiwicG9ydCI6MjYzNzl9LHsiaG9zdCI6InNlbnRpbmVsLTEiLCJwb3J0IjoyNjM3OX1dLCJuYW1lIjoibXltYXN0ZXIifQ==

# URL should point to the fully qualified, publicly accessible URL. If using a
# proxy the port in URL and PORT may be different.
URL=https://outline.example.com
PORT=3000

# See [documentation](docs/SERVICES.md) on running a separate collaboration
# server, for normal operation this does not need to be set.
COLLABORATION_URL=

# To support uploading of images for avatars and document attachments an
# s3-compatible storage must be provided. AWS S3 is recommended for redundancy
# however if you want to keep all file storage local an alternative such as
# minio (https://github.com/minio/minio) can be used.

# A more detailed guide on setting up S3 is available here:
# => https://wiki.generaloutline.com/share/125de1cc-9ff6-424b-8415-0d58c809a40f
#
AWS_ACCESS_KEY_ID=access_key_of_minio_outline
AWS_SECRET_ACCESS_KEY=secret_key_of_minio_outline
AWS_REGION=cn-outline-1
AWS_S3_ACCELERATE_URL=
AWS_S3_UPLOAD_BUCKET_URL=https://minio.example.com
AWS_S3_UPLOAD_BUCKET_NAME=outline
AWS_S3_UPLOAD_MAX_SIZE=26214400
AWS_S3_FORCE_PATH_STYLE=true
AWS_S3_ACL=private


# â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ AUTHENTICATION â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“

# Third party signin credentials, at least ONE OF EITHER Google, Slack,
# or Microsoft is required for a working installation or you'll have no sign-in
# options.

# To configure Slack auth, you'll need to create an Application at
# => https://api.slack.com/apps
#
# When configuring the Client ID, add a redirect URL under "OAuth & Permissions":
# https://<URL>/auth/slack.callback

# SLACK_CLIENT_ID=
# SLACK_CLIENT_SECRET=

# To configure Google auth, you'll need to create an OAuth Client ID at
# => https://console.cloud.google.com/apis/credentials
#
# When configuring the Client ID, add an Authorized redirect URI:
# https://<URL>/auth/google.callback

# GOOGLE_CLIENT_ID=203306213201-3ildae9if5t458eu5dq8f073pjv11rck.apps.googleusercontent.com
# GOOGLE_CLIENT_SECRET=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

# To configure Microsoft/Azure auth, you'll need to create an OAuth Client. See
# the guide for details on setting up your Azure App:
# => https://wiki.generaloutline.com/share/dfa77e56-d4d2-4b51-8ff8-84ea6608faa4

# AZURE_CLIENT_ID=
# AZURE_CLIENT_SECRET=
# AZURE_RESOURCE_APP_ID=

# To configure generic OIDC auth, you'll need some kind of identity provider.
# See documentation for whichever IdP you use to acquire the following info:
# Redirect URI is https://<URL>/auth/oidc.callback
OIDC_CLIENT_ID=outline
OIDC_CLIENT_SECRET=secret_of_keycloak_outline_client
OIDC_AUTH_URI=https://sso.example.com/auth/realms/outline/protocol/openid-connect/auth
OIDC_TOKEN_URI=https://sso.example.com/auth/realms/outline/protocol/openid-connect/token
OIDC_USERINFO_URI=https://sso.example.com/auth/realms/outline/protocol/openid-connect/userinfo

# Specify which claims to derive user information from
# Supports any valid JSON path with the JWT payload
OIDC_USERNAME_CLAIM=preferred_username

# Display name for OIDC authentication
OIDC_DISPLAY_NAME=Keycloak

# Space separated auth scopes.
OIDC_SCOPES=profile email


# â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ OPTIONAL â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“

# Base64 encoded private key and certificate for HTTPS termination. This is only
# required if you do not use an external reverse proxy. See documentation:
# https://wiki.generaloutline.com/share/1c922644-40d8-41fe-98f9-df2b67239d45
SSL_KEY=
SSL_CERT=

# If using a Cloudfront/Cloudflare distribution or similar it can be set below.
# This will cause paths to javascript, stylesheets, and images to be updated to
# the hostname defined in CDN_URL. In your CDN configuration the origin server
# should be set to the same as URL.
CDN_URL=

# Auto-redirect to https in production. The default is true but you may set to
# false if you can be sure that SSL is terminated at an external loadbalancer.
FORCE_HTTPS=false

# Have the installation check for updates by sending anonymized statistics to
# the maintainers
ENABLE_UPDATES=true

# How many processes should be spawned. As a reasonable rule divide your servers
# available memory by 512 for a rough estimate
WEB_CONCURRENCY=2

# Override the maximum size of document imports, could be required if you have
# especially large Word documents with embedded imagery
MAXIMUM_IMPORT_SIZE=5120000

# You can remove this line if your reverse proxy already logs incoming http
# requests and this ends up being duplicative
DEBUG=http

# Configure lowest severity level for server logs. Should be one of
# error, warn, info, http, verbose, debug and silly
LOG_LEVEL=info

# For a complete Slack integration with search and posting to channels the
# following configs are also needed, some more details
# => https://wiki.generaloutline.com/share/be25efd1-b3ef-4450-b8e5-c4a4fc11e02a
#
# SLACK_VERIFICATION_TOKEN=your_token
# SLACK_APP_ID=A0XXXXXXX
# SLACK_MESSAGE_ACTIONS=true

# Optionally enable google analytics to track pageviews in the knowledge base
GOOGLE_ANALYTICS_ID=

# Optionally enable Sentry (sentry.io) to track errors and performance,
# and optionally add a Sentry proxy tunnel for bypassing ad blockers in the UI:
# https://docs.sentry.io/platforms/javascript/troubleshooting/#using-the-tunnel-option)
SENTRY_DSN=
SENTRY_TUNNEL=

# To support sending outgoing transactional emails such as "document updated" or
# "you've been invited" you'll need to provide authentication for an SMTP server
SMTP_HOST=
SMTP_PORT=
SMTP_USERNAME=
SMTP_PASSWORD=
SMTP_FROM_EMAIL=hello@example.com
SMTP_REPLY_EMAIL=hello@example.com
SMTP_TLS_CIPHERS=
SMTP_SECURE=true

# The default interface language. See translate.getoutline.com for a list of
# available language codes and their rough percentage translated.
DEFAULT_LANGUAGE=zh_CN

# Optionally enable rate limiter at application web server
RATE_LIMITER_ENABLED=true

# Configure default throttling parameters for rate limiter
RATE_LIMITER_REQUESTS=1000
RATE_LIMITER_DURATION_WINDOW=60

# Iframely API config
IFRAMELY_URL=
IFRAMELY_API_KEY=
```



## 7.3 `outline-docker.env` é…ç½®æ–‡ä»¶è¯¦è§£

```properties
# â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ REQUIRED â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“

# ================ Outline ================
NODE_ENV=production
# ä¸€ä¸ªåå…­è¿›åˆ¶ç¼–ç çš„ 32 å­—èŠ‚éšæœºå¯†é’¥ã€‚å®˜æ–¹æ¨èä½¿ç”¨ `openssl rand -hex 32` åœ¨ä½ çš„ç»ˆç«¯ç”Ÿæˆ
SECRET_KEY=secret_key
# ä¸€ä¸ªå”¯ä¸€çš„éšæœºå¯†é’¥ã€‚æ ¼å¼å¹¶ä¸é‡è¦ï¼Œå®˜æ–¹æ¨èä½¿ç”¨ `openssl rand -hex 32` åœ¨ä½ çš„ç»ˆç«¯ç”Ÿæˆ
UTILS_SECRET=utils_secret
# è¡¨ç¤ºå¤–éƒ¨æµè§ˆå™¨å°†ä¼šä»¥ä»€ä¹ˆåŸŸåè¿æ¥ Outline
# è¯·ä¸€å®šè¦è®¾ç½®ä¸º httpsï¼Œå¦åˆ™ä¼šå‡ºç°ç™»é™†å¤±è´¥çš„é—®é¢˜
# ä¿®æ”¹é¡¹: 
# 1. outline.example.com: ä¿®æ”¹ä¸ºä½ è‡ªå·±çš„åŸŸå
URL=https://outline.example.com
# è¡¨ç¤º Outline ä½¿ç”¨çš„ç«¯å£ï¼Œè¯·æ”¾å¿ƒè®¾ç½®ï¼Œå› ä¸ºä¸ä¼šå ç”¨å®¿ä¸»æœºçš„ç«¯å£ä½ç½®ï¼Œä»…ä»…ä½œç”¨äºå®¹å™¨å†…çš„ç«¯å£
PORT=3000
# =========================================


# ================ PostgreSQL ================
# ç”¨äºè¿æ¥ PostgreSQL çš„ URL
# ä¿®æ”¹é¡¹:
# 1. password_of_outline_user: æ˜¯ä½ å½“æ—¶éƒ¨ç½² PostgreSQL åï¼Œè¿›å…¥å®¹å™¨åˆ›å»ºçš„ outline ç”¨æˆ·çš„å¯†ç 
DATABASE_URL=postgres://outline:password_of_outline_user@postgres12:5432/outline
DATABASE_URL_TEST=postgres://outline:password_of_outline_user@postgres12:5432/outline_test
# PostgreSQL æ•°æ®åº“å¼€å¯ SSL é“¾è·¯åŠ å¯†åï¼Œè¡¨ç¤ºå…è®¸å®¢æˆ·ç«¯é€šè¿‡ SSL è¿æ¥æ•°æ®åº“
# ç”±äºæˆ‘ä»¬æ²¡æœ‰åä»£ PostgreSQLï¼Œä¹Ÿæ²¡æœ‰ä¸º PostgreSQL é…ç½® SSLï¼Œä»…ä»…åœ¨å±€åŸŸç½‘å†…è®¿é—®
# å› æ­¤éœ€è¦å°†æ­¤ç¯å¢ƒå˜é‡è®¾ä¸º disable
PGSSLMODE=disable
# ============================================


# ================ Redis ================
# ç”¨äºè¿æ¥ Redis çš„ URL
# ä¿®æ”¹é¡¹:
# 1. password_of_redis: æ˜¯å½“æ—¶éƒ¨ç½² Redis æ—¶ï¼Œä½äº redis-docker-compose.yaml ä¸­çš„å¯†ç 
REDIS_URL=redis://:password_of_redis@redis:6379
# =======================================


# ================ MinIO ================
# è¿™æ˜¯æˆ‘ä»¬ MinIO ç®¡ç†ç•Œé¢æ–°æ·»åŠ çš„ User çš„ Access Key å­—æ®µ
AWS_ACCESS_KEY_ID=access_key_of_minio_outline
# è¿™æ˜¯æˆ‘ä»¬ MinIO ç®¡ç†ç•Œé¢æ–°æ·»åŠ çš„ User çš„ Secret Key å­—æ®µ
AWS_SECRET_ACCESS_KEY=secret_key_of_minio_outline
# ä½äº minio-docker-compose.yaml çš„å­—æ®µ
AWS_REGION=cn-outline-1
# é€šè¿‡ Nginx åä»£åçš„åœ°å€
# ä¿®æ”¹é¡¹: 
# 1. minio.example.com: ä¿®æ”¹ä¸ºä½ è‡ªå·±çš„åŸŸå
AWS_S3_UPLOAD_BUCKET_URL=https://minio.example.com
# è¿™æ˜¯æˆ‘ä»¬åœ¨ MinIO ç®¡ç†ç•Œé¢æ–°æ·»åŠ çš„ Bucket çš„åç§°
AWS_S3_UPLOAD_BUCKET_NAME=outline
# æˆ‘ä»¬æ·»åŠ çš„ Bucket é»˜è®¤æ˜¯ private çš„
AWS_S3_ACL=private

# ä¸€äº›é¢å¤–çš„é…ç½®é¡¹ï¼Œæ›´å¤šçš„å¯ä»¥çœ‹æ–‡æ¡£ï¼Œæ¥æ›´å¥½åœ°æ»¡è¶³è‡ªå·±éœ€æ±‚
AWS_S3_UPLOAD_MAX_SIZE=26214400
# é»˜è®¤æƒ…å†µä¸‹ï¼Œè®¸å¤š S3 å®¢æˆ·ç«¯åº“ä¼šä½¿ç”¨å­åŸŸåæ ·å¼ã€‚ç„¶è€Œï¼Œæœ‰æ—¶è¿™å¯èƒ½ä¼šå¯¼è‡´é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯å½“å­˜å‚¨æ¡¶åç§°åŒ…å«ç‚¹"."æˆ–ä¸ç¬¦åˆDNSå­åŸŸåè§„èŒƒæ—¶
# è®¾ç½® AWS_S3_FORCE_PATH_STYLE ä¸º true ä¼šå¼ºåˆ¶å®¢æˆ·ç«¯åº“ä½¿ç”¨è·¯å¾„æ ·å¼ï¼Œè€Œä¸æ˜¯å­åŸŸåæ ·å¼
AWS_S3_FORCE_PATH_STYLE=true
# =======================================

# â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“------------â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“




# â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“ AUTHENTICATION â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
# Outline è‡³å°‘éœ€è¦é…ç½®ä¸€ä¸ªæˆæƒæ–¹å¼ï¼Œæˆ‘ä»¬åœ¨ä¹‹å‰éƒ¨ç½²äº† Keycloak å¯ä»¥ä½œä¸ºæˆ‘ä»¬çš„ OIDC æœåŠ¡

# ============== Keycloak OIDC ==============
# è¿™æ˜¯æˆ‘ä»¬åœ¨ Keycloak ç®¡ç†ç•Œé¢æ–°æ·»åŠ  Client æ—¶ï¼Œè®¾ç½®çš„ Client åç§°
OIDC_CLIENT_ID=outline
# è¿™æ˜¯æˆ‘ä»¬åœ¨ Outline Client è®¾ç½®ç•Œé¢ï¼ŒCredentials é€‰é¡¹å¡ä¸­çš„ Secret å­—æ®µ
# ä½ å¯ä»¥çœ‹æœ¬æ–‡çš„ `5.3.4 é…ç½® Outline Client` æ¥æŸ¥çœ‹å›¾ç‰‡å¿«é€Ÿæ‰¾åˆ°ä½ç½®
OIDC_CLIENT_SECRET=secret_of_keycloak_outline_client
# ä»¥ä¸‹æ˜¯ Outline ç”¨äºå®Œæˆ OIDC éªŒè¯çš„ API æ¥å£ï¼Œå…¶ä½™åœ°æ–¹å‡æ— éœ€ä¿®æ”¹ï¼Œåªéœ€è¦ä¿®æ”¹åŸŸå
# ä¿®æ”¹é¡¹
# 1. sso.example.com: ä¿®æ”¹ä¸ºä½ è‡ªå·±çš„åŸŸå
OIDC_AUTH_URI=https://sso.example.com/auth/realms/outline/protocol/openid-connect/auth
OIDC_TOKEN_URI=https://sso.example.com/auth/realms/outline/protocol/openid-connect/token
OIDC_USERINFO_URI=https://sso.example.com/auth/realms/outline/protocol/openid-connect/userinfo
# è¿™ä¸ªåå­—å°†å±•ç¤ºåœ¨ https://outline.example.com çš„é¦–é¡µï¼Œç™»é™†é€‰é¡¹ä¸­å°†ä¼šæ˜¾ç¤º â€œä½¿ç”¨ Keycloak ç»§ç»­â€
OIDC_DISPLAY_NAME=Keycloak
# é»˜è®¤æ˜¯ openid profile emailï¼Œè¡¨ç¤ºå…è®¸ç”¨æˆ·ä½¿ç”¨ä»€ä¹ˆæ–¹å¼ç™»å½•
# openid: æˆ‘ä»¬ Keycloak è®¾å®šçš„ openid æ˜¯ä¸€ä¸ª UUIDï¼Œå› ä¸ºå¤ªé•¿äº†æ‰€ä»¥ç”¨æ¥ç™»é™†ä¹Ÿä¸åˆé€‚
# profile: å°±æ˜¯æˆ‘ä»¬çš„è´¦æˆ·åç§° Usernameï¼Œæ³¨æ„ä¸æ˜¯ First/Last Name å­—æ®µ
# email: å°±æ˜¯æˆ‘ä»¬åˆ›å»ºè´¦æˆ·æ˜¯ï¼Œå¯ä»¥å¡«å…¥çš„ email å­—æ®µ
OIDC_SCOPES=profile email
# ===========================================

# â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“-----------------â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“â€“
```



## 7.4 åˆå§‹åŒ–æ•°æ®åº“

æˆ‘ä»¬åœ¨ä¹‹å‰å·²ç»åœ¨ PostgreSQL ä¸­åˆ›å»ºå¥½äº† outline å’Œ outline-test çš„æ•°æ®åº“

å¦‚æœæ²¡æœ‰åˆ›å»ºï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å¿«é€Ÿåˆ›å»º

```bash
# ç¡®ä¿è¿›å…¥åˆ° "outline-docker-compose.yaml" åŒçº§ç›®å½•
cd /home/docker-compose/outline
# åˆ›å»º outline å’Œ outline-test æ•°æ®åº“
docker-compose run \
    -f outline-docker-compose.yml \
    --rm outline \
    yarn db:create \
    --env=production-ssl-disabled
```

é™¤äº†åˆ›å»ºæ•°æ®åº“ï¼Œè¿˜éœ€è¦åˆ›å»ºè¡¨å’Œç´¢å¼•

```bash
# ç¡®ä¿è¿›å…¥åˆ° "outline-docker-compose.yaml" åŒçº§ç›®å½•
cd /home/docker-compose/outline
# åˆå§‹åŒ–æ•°æ®åº“: æ·»åŠ è¡¨å’Œç´¢å¼•
docker-compose run \
    -f outline-docker-compose.yml \
    --rm outline \
    yarn db:migrate \
    --env=production-ssl-disabled
```



## 7.5 ä½¿ç”¨ Docker-Compose éƒ¨ç½² Outline

åœ¨æ­¤ä¹‹å‰ç¡®ä¿å·²ç»åˆ›å»ºå¥½äº† `outline-docker.env`, `outline-docker-compose.yaml`ï¼Œä¹Ÿåˆ›å»ºå¥½äº† `outline`, `outline-test` æ•°æ®åº“ï¼Œå¹¶ä¸”ä¹Ÿåˆ›å»ºå¥½äº†è¡¨å’Œç´¢å¼•ã€‚

```bash
# ç¡®ä¿è¿›å…¥åˆ° "outline-docker-compose.yaml" åŒçº§ç›®å½•
cd /home/docker-compose/outline
# ä½¿ç”¨ docker-compose å¯åŠ¨ outline
docker-compose -f outline-docker-compose.yaml up -d
```



# 8. åˆæ­¥æµ‹è¯•

## 8.1 ç™»é™† Outline

æ‰“å¼€ `outline.example.com`ï¼Œå†ä½¿ç”¨ Keycloak ç»§ç»­

![8-use-outline-01](./assets/8-use-outline-01.png)

ä¹‹åå°†è·³è½¬åˆ° `sso.example.com`ï¼Œå®Œæˆç™»é™†åå°†è‡ªåŠ¨è·³è½¬åˆ° Outline ä¸»ç•Œé¢ã€‚

è¿™é‡Œçš„ç”¨æˆ·åå’Œå¯†ç éƒ½æ˜¯æˆ‘ä»¬åœ¨ Keycloak ä¸­å®šä¹‰çš„

![8-use-outline-02](./assets/8-use-outline-02.png)



## 8.2 æµ‹è¯• PostgreSQL åŸºæœ¬åŠŸèƒ½

åœ¨ä¸»ç•Œé¢å·¦ä¾§æ–°å»ºæ–‡æ¡£ï¼Œå¦‚æœèƒ½å¤Ÿåˆ›å»ºï¼ŒåŸºæœ¬ä¸Šè¯´æ˜ PostgreSQL æ˜¯èƒ½å¤Ÿæ­£å¸¸è¿è¡Œçš„

![8-use-outline-03](./assets/8-use-outline-03.png)





## 8.3 æµ‹è¯• MinIO åŸºæœ¬åŠŸèƒ½

åœ¨æ–°å»ºçš„æ–‡æ¡£å†…æ·»åŠ ä¸€ä¸ªå›¾ç‰‡ï¼Œè¯¥å›¾ç‰‡å°†ä¸Šä¼ åˆ° MinIO çš„ Outline Bucket ä¸­

![8-use-outline-04-upload-pic](./assets/8-use-outline-04-upload-pic.png)

è¿›ä¸€æ­¥çš„ï¼Œä½ è¿˜å¯ä»¥ç™»é™† `minio-admin.example.com` æˆ–è€… `minio.example.com` (è‡ªåŠ¨è·³è½¬è‡³ admin åŸŸå)ï¼Œç™»é™†åä½ å°†çœ‹åˆ°ã€‚å¦‚æœä½ çš„ Total Objects ä¸º 0ï¼Œè¯·ç­‰å¾…ä¸€æ®µæ—¶é—´æˆ–è€…å¼ºåˆ¶åˆ·æ–°æµè§ˆå™¨ï¼ˆæ¸…é™¤ç¼“å­˜ï¼‰

è¿˜æœ‰å°±æ˜¯å¦‚æœä½ åœ¨ä¸€ä¸ªæ–‡ç« ä¸­ä¸Šä¼ å¤šä¸ªå›¾ç‰‡ï¼Œå®é™…ä¸Šä¼šåŒ…è£¹è¿›ç”¨ä¸€ä¸ªå¯¹è±¡ä¸­å»ï¼ŒTotal Object ä¸ç­‰äºä¸Šä¼ çš„å›¾ç‰‡æ•°é‡ï¼ˆå…·ä½“çš„è§„åˆ™æˆ‘æ²¡æœ‰ç»†è¯»å®˜æ–¹æ–‡æ¡£ï¼Œè¿™æ˜¯æˆ‘è§‚å¯Ÿåçš„æƒ³æ³•ï¼Œå¦‚æœ‰é—®é¢˜ï¼Œæ¬¢è¿çº é”™ï¼‰

å¦å¤–ä½ è¿˜å¯ä»¥è¿›å…¥ Object Browser æ¥æŸ¥çœ‹ Outline Bucket ä¸­æœ‰å“ªäº›æ–‡ä»¶ï¼Œå…·ä½“ä½¿ç”¨å¯ä»¥å‚è€ƒå·¦ä¾§æ ç›®çš„æœ€åä¸€æ æœ‰ä¸€ä¸ª [Documentation](https://min.io/docs/minio/kubernetes/upstream/index.html?ref=docs-redirect&ref=con)

![8-use-outline-04-minio-display](./assets/8-use-outline-04-minio-display.png)



## 8.4 æ›´å¤šåŠŸèƒ½

æ›´å¤šåŠŸèƒ½è¿˜å¾…è‡ªå·±å»å°è¯•ï¼Œè¿™é‡Œå°±ä¸å‰§é€äº†ã€‚

å¦‚æ­¤ç•Œé¢ä¼˜ç¾ã€åŠŸèƒ½é½å…¨ã€å¤šäººå®æ—¶ååŒã€æƒé™ç®¡ç†ã€å¯ç§äººéƒ¨ç½²çš„å¼€æº Wiki é¡¹ç›®ï¼Œæˆ‘ä¸å…è®¸å¤§å®¶ä¸çŸ¥é“ï¼å¸Œæœ› Outline èƒ½æ‹¥æœ‰æ›´å¤šçš„ç”¨æˆ·ï¼Œå˜å¾—æ›´å¥½~



# 9. å‚è€ƒèµ„æ–™

ä»–äººåˆ†äº«çš„éƒ¨ç½²æ•™ç¨‹ç³»åˆ—ï¼š

- Outline æ­å»ºï¼šhttps://biteax.com/b9dce220.html
- Outline æ­å»ºï¼šhttps://github.com/soulteary/docker-outline
- Outline æ­å»ºï¼šhttps://zhuanlan.zhihu.com/p/411062890
- Keycloak æ­å»ºï¼šhttps://gitee.com/itmuch/spring-cloud-yes/tree/master/doc/keycloak-learn
- Keycloak+Outline æ­å»ºï¼šhttps://blog.yarsalabs.com/self-hosting-outline-wiki-on-cloudron/



å®˜æ–¹æ–‡æ¡£ç³»åˆ—ï¼š

- Outlineï¼šhttps://docs.getoutline.com/s/hosting/doc/docker-7pfeLP5a8t
- Nginxï¼šhttps://nginx.org/en/docs/
- Keycloakï¼šhttps://www.keycloak.org/documentation.html
- Keycloakï¼šhttps://keycloak.org.cn/docs/latest/getting_started/index.html
- MinIO for Dockerï¼šhttps://min.io/docs/minio/container/index.html
- PostgreSQL 12: https://www.postgresql.org/docs/12/index.html
- Redis: https://redis.io/docs/



Github Issue ç³»åˆ—:

- Outline+KeyCloakå‡ºç°çš„é—®é¢˜ï¼šhttps://github.com/outline/outline/discussions/2716



é…ç½®æ–‡ä»¶çš„è¦ç‚¹ç³»åˆ—ï¼š

- ä½¿ç”¨ Nginx åä»£ Outline: [Outline/Configuration/Nginx](https://docs.getoutline.com/s/hosting/doc/nginx-6htaRboR57)
- ä½¿ç”¨ Nginx åä»£ Minio:  [Integrations/Configure NGINX Proxy for MinIO Server](http://minio.org.cn/docs/minio/linux/integrations/setup-nginx-proxy-with-minio.html)ã€‚
- ä½¿ç”¨ Nginx åä»£ Keycloak: [Guides/Server/Using a reverse proxy](https://www.keycloak.org/server/reverseproxy)




ä¸€äº›å­—æ®µå’Œç»†èŠ‚ï¼š

- è·å–OIDC_CLIENT_SECRETï¼šhttps://blog.csdn.net/MRLEE1212/article/details/103902379
- Nginx åä»£ Outlineæ³¨æ„äº‹é¡¹ï¼šhttps://docs.getoutline.com/s/hosting/doc/nginx-6htaRboR57



# X. Change Log

---

- v1.0.0ï¼š2023å¹´08æœˆ13æ—¥ 22:03:24
  - å®Œæˆç¬¬ä¸€ç‰ˆæ–‡æ¡£


---

---

æœ¬æ–‡äº2023å¹´08æœˆ13æ—¥å®Œæˆï¼Œå¦‚æœ‰é—®é¢˜æ¬¢è¿è”ç³»æˆ‘ğŸ˜Š: 

- emailtojiang@gmail.com
- emailtojiang@163.com

---

---

<div style="text-align: center; margin-bottom: 100px; margin-top: 100px; font-family: 'Courier New', Courier, monospace; font-size: 24px; color: #4A90E2; padding-top: 20px;">
  <span style="background-color: #F2F2F2; padding: 10px; border-radius: 5px;">âœ¨ The End âœ¨</span>
</div>


